
<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta http-equiv="X-UA-Compatible" content="IE=edge" />
  <meta name="HandheldFriendly" content="True" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <meta name="robots" content="" />

  <link href="https://fonts.googleapis.com/css?family=Source+Code+Pro|Source+Sans+Pro:300,400,400i,700" rel="stylesheet">

    <link rel="stylesheet" type="text/css" href="https://dasturge.github.io/theme/stylesheet/style.min.css">

  <link rel="stylesheet" type="text/css" href="https://dasturge.github.io/theme/pygments/github.min.css">
  <link rel="stylesheet" type="text/css" href="https://dasturge.github.io/theme/font-awesome/css/font-awesome.min.css">


    <link href="https://dasturge.github.io/feeds/all.atom.xml" type="application/atom+xml" rel="alternate" title="S Vision Atom">





<meta name="author" content="Darrick Sturgeon" />
<meta name="description" content="a look at spatial transformer networks from Deepmind" />
<meta name="keywords" content="computer vision, transforms, python, tensorflow">

<meta property="og:site_name" content="S Vision"/>
<meta property="og:title" content="Spatial transformer Networks"/>
<meta property="og:description" content="a look at spatial transformer networks from Deepmind"/>
<meta property="og:locale" content="en_US"/>
<meta property="og:url" content="https://dasturge.github.io/spatial-transformer-networks.html"/>
<meta property="og:type" content="article"/>
<meta property="article:published_time" content="2019-02-27 00:00:00-08:00"/>
<meta property="article:modified_time" content=""/>
<meta property="article:author" content="https://dasturge.github.io/author/darrick-sturgeon.html">
<meta property="article:section" content="Imaging"/>
<meta property="article:tag" content="computer vision"/>
<meta property="article:tag" content="transforms"/>
<meta property="article:tag" content="python"/>
<meta property="article:tag" content="tensorflow"/>
<meta property="og:image" content="/images/profile.jpg">

  <title>S Vision &ndash; Spatial transformer Networks</title>

</head>
<body>
  <aside>
    <div>
      <a href="https://dasturge.github.io">
        <img src="/images/profile.jpg" alt="" title="">
      </a>
      <h1><a href="https://dasturge.github.io"></a></h1>


      <nav>
        <ul class="list">

          <li><a href="about-me.html" target="_blank">About Me</a></li>
          <li><a href="category/imaging.html" target="_blank">Imaging</a></li>
          <li><a href="https://github.com/dasturge" target="_blank">My Github</a></li>
          <li><a href="https://github.com/DCAN-Labs" target="_blank">DCAN-labs Github</a></li>
          <li><a href="http://python.org/" target="_blank">Python.org</a></li>
        </ul>
      </nav>

      <ul class="social">
      </ul>
    </div>


  </aside>
  <main>


<article class="single">
  <header>
      
    <h1 id="spatial-transformer-networks">Spatial transformer Networks</h1>
    <p>
          Posted on Wed 27 February 2019 in <a href="https://dasturge.github.io/category/imaging.html">Imaging</a>


    </p>
  </header>


  <div>
    <style type="text/css">/*!
*
* IPython notebook
*
*/
/* CSS font colors for translated ANSI colors. */
.ansibold {
  font-weight: bold;
}
/* use dark versions for foreground, to improve visibility */
.ansiblack {
  color: black;
}
.ansired {
  color: darkred;
}
.ansigreen {
  color: darkgreen;
}
.ansiyellow {
  color: #c4a000;
}
.ansiblue {
  color: darkblue;
}
.ansipurple {
  color: darkviolet;
}
.ansicyan {
  color: steelblue;
}
.ansigray {
  color: gray;
}
/* and light for background, for the same reason */
.ansibgblack {
  background-color: black;
}
.ansibgred {
  background-color: red;
}
.ansibggreen {
  background-color: green;
}
.ansibgyellow {
  background-color: yellow;
}
.ansibgblue {
  background-color: blue;
}
.ansibgpurple {
  background-color: magenta;
}
.ansibgcyan {
  background-color: cyan;
}
.ansibggray {
  background-color: gray;
}
div.cell {
  /* Old browsers */
  display: -webkit-box;
  -webkit-box-orient: vertical;
  -webkit-box-align: stretch;
  display: -moz-box;
  -moz-box-orient: vertical;
  -moz-box-align: stretch;
  display: box;
  box-orient: vertical;
  box-align: stretch;
  /* Modern browsers */
  display: flex;
  flex-direction: column;
  align-items: stretch;
  border-radius: 2px;
  box-sizing: border-box;
  -moz-box-sizing: border-box;
  -webkit-box-sizing: border-box;
  border-width: 1px;
  border-style: solid;
  border-color: transparent;
  width: 100%;
  padding: 5px;
  /* This acts as a spacer between cells, that is outside the border */
  margin: 0px;
  outline: none;
  border-left-width: 1px;
  padding-left: 5px;
  background: linear-gradient(to right, transparent -40px, transparent 1px, transparent 1px, transparent 100%);
}
div.cell.jupyter-soft-selected {
  border-left-color: #90CAF9;
  border-left-color: #E3F2FD;
  border-left-width: 1px;
  padding-left: 5px;
  border-right-color: #E3F2FD;
  border-right-width: 1px;
  background: #E3F2FD;
}
@media print {
  div.cell.jupyter-soft-selected {
    border-color: transparent;
  }
}
div.cell.selected {
  border-color: #ababab;
  border-left-width: 0px;
  padding-left: 6px;
  background: linear-gradient(to right, #42A5F5 -40px, #42A5F5 5px, transparent 5px, transparent 100%);
}
@media print {
  div.cell.selected {
    border-color: transparent;
  }
}
div.cell.selected.jupyter-soft-selected {
  border-left-width: 0;
  padding-left: 6px;
  background: linear-gradient(to right, #42A5F5 -40px, #42A5F5 7px, #E3F2FD 7px, #E3F2FD 100%);
}
.edit_mode div.cell.selected {
  border-color: #66BB6A;
  border-left-width: 0px;
  padding-left: 6px;
  background: linear-gradient(to right, #66BB6A -40px, #66BB6A 5px, transparent 5px, transparent 100%);
}
@media print {
  .edit_mode div.cell.selected {
    border-color: transparent;
  }
}
.prompt {
  /* This needs to be wide enough for 3 digit prompt numbers: In[100]: */
  min-width: 14ex;
  /* This padding is tuned to match the padding on the CodeMirror editor. */
  padding: 0.4em;
  margin: 0px;
  font-family: monospace;
  text-align: right;
  /* This has to match that of the the CodeMirror class line-height below */
  line-height: 1.21429em;
  /* Don't highlight prompt number selection */
  -webkit-touch-callout: none;
  -webkit-user-select: none;
  -khtml-user-select: none;
  -moz-user-select: none;
  -ms-user-select: none;
  user-select: none;
  /* Use default cursor */
  cursor: default;
}
@media (max-width: 540px) {
  .prompt {
    text-align: left;
  }
}
div.inner_cell {
  min-width: 0;
  /* Old browsers */
  display: -webkit-box;
  -webkit-box-orient: vertical;
  -webkit-box-align: stretch;
  display: -moz-box;
  -moz-box-orient: vertical;
  -moz-box-align: stretch;
  display: box;
  box-orient: vertical;
  box-align: stretch;
  /* Modern browsers */
  display: flex;
  flex-direction: column;
  align-items: stretch;
  /* Old browsers */
  -webkit-box-flex: 1;
  -moz-box-flex: 1;
  box-flex: 1;
  /* Modern browsers */
  flex: 1;
}
/* input_area and input_prompt must match in top border and margin for alignment */
div.input_area {
  border: 1px solid #cfcfcf;
  border-radius: 2px;
  background: #f7f7f7;
  line-height: 1.21429em;
}
/* This is needed so that empty prompt areas can collapse to zero height when there
   is no content in the output_subarea and the prompt. The main purpose of this is
   to make sure that empty JavaScript output_subareas have no height. */
div.prompt:empty {
  padding-top: 0;
  padding-bottom: 0;
}
div.unrecognized_cell {
  padding: 5px 5px 5px 0px;
  /* Old browsers */
  display: -webkit-box;
  -webkit-box-orient: horizontal;
  -webkit-box-align: stretch;
  display: -moz-box;
  -moz-box-orient: horizontal;
  -moz-box-align: stretch;
  display: box;
  box-orient: horizontal;
  box-align: stretch;
  /* Modern browsers */
  display: flex;
  flex-direction: row;
  align-items: stretch;
}
div.unrecognized_cell .inner_cell {
  border-radius: 2px;
  padding: 5px;
  font-weight: bold;
  color: red;
  border: 1px solid #cfcfcf;
  background: #eaeaea;
}
div.unrecognized_cell .inner_cell a {
  color: inherit;
  text-decoration: none;
}
div.unrecognized_cell .inner_cell a:hover {
  color: inherit;
  text-decoration: none;
}
@media (max-width: 540px) {
  div.unrecognized_cell > div.prompt {
    display: none;
  }
}
div.code_cell {
  /* avoid page breaking on code cells when printing */
}
@media print {
  div.code_cell {
    page-break-inside: avoid;
  }
}
/* any special styling for code cells that are currently running goes here */
div.input {
  page-break-inside: avoid;
  /* Old browsers */
  display: -webkit-box;
  -webkit-box-orient: horizontal;
  -webkit-box-align: stretch;
  display: -moz-box;
  -moz-box-orient: horizontal;
  -moz-box-align: stretch;
  display: box;
  box-orient: horizontal;
  box-align: stretch;
  /* Modern browsers */
  display: flex;
  flex-direction: row;
  align-items: stretch;
}
@media (max-width: 540px) {
  div.input {
    /* Old browsers */
    display: -webkit-box;
    -webkit-box-orient: vertical;
    -webkit-box-align: stretch;
    display: -moz-box;
    -moz-box-orient: vertical;
    -moz-box-align: stretch;
    display: box;
    box-orient: vertical;
    box-align: stretch;
    /* Modern browsers */
    display: flex;
    flex-direction: column;
    align-items: stretch;
  }
}
/* input_area and input_prompt must match in top border and margin for alignment */
div.input_prompt {
  color: #303F9F;
  border-top: 1px solid transparent;
}
div.input_area > div.highlight {
  margin: 0.4em;
  border: none;
  padding: 0px;
  background-color: transparent;
}
div.input_area > div.highlight > pre {
  margin: 0px;
  border: none;
  padding: 0px;
  background-color: transparent;
}
/* The following gets added to the <head> if it is detected that the user has a
 * monospace font with inconsistent normal/bold/italic height.  See
 * notebookmain.js.  Such fonts will have keywords vertically offset with
 * respect to the rest of the text.  The user should select a better font.
 * See: https://github.com/ipython/ipython/issues/1503
 *
 * .CodeMirror span {
 *      vertical-align: bottom;
 * }
 */
.CodeMirror {
  line-height: 1.21429em;
  /* Changed from 1em to our global default */
  font-size: 14px;
  height: auto;
  /* Changed to auto to autogrow */
  background: none;
  /* Changed from white to allow our bg to show through */
}
.CodeMirror-scroll {
  /*  The CodeMirror docs are a bit fuzzy on if overflow-y should be hidden or visible.*/
  /*  We have found that if it is visible, vertical scrollbars appear with font size changes.*/
  overflow-y: hidden;
  overflow-x: auto;
}
.CodeMirror-lines {
  /* In CM2, this used to be 0.4em, but in CM3 it went to 4px. We need the em value because */
  /* we have set a different line-height and want this to scale with that. */
  padding: 0.4em;
}
.CodeMirror-linenumber {
  padding: 0 8px 0 4px;
}
.CodeMirror-gutters {
  border-bottom-left-radius: 2px;
  border-top-left-radius: 2px;
}
.CodeMirror pre {
  /* In CM3 this went to 4px from 0 in CM2. We need the 0 value because of how we size */
  /* .CodeMirror-lines */
  padding: 0;
  border: 0;
  border-radius: 0;
}
/*

Original style from softwaremaniacs.org (c) Ivan Sagalaev <Maniac@SoftwareManiacs.Org>
Adapted from GitHub theme

*/
.highlight-base {
  color: #000;
}
.highlight-variable {
  color: #000;
}
.highlight-variable-2 {
  color: #1a1a1a;
}
.highlight-variable-3 {
  color: #333333;
}
.highlight-string {
  color: #BA2121;
}
.highlight-comment {
  color: #408080;
  font-style: italic;
}
.highlight-number {
  color: #080;
}
.highlight-atom {
  color: #88F;
}
.highlight-keyword {
  color: #008000;
  font-weight: bold;
}
.highlight-builtin {
  color: #008000;
}
.highlight-error {
  color: #f00;
}
.highlight-operator {
  color: #AA22FF;
  font-weight: bold;
}
.highlight-meta {
  color: #AA22FF;
}
/* previously not defined, copying from default codemirror */
.highlight-def {
  color: #00f;
}
.highlight-string-2 {
  color: #f50;
}
.highlight-qualifier {
  color: #555;
}
.highlight-bracket {
  color: #997;
}
.highlight-tag {
  color: #170;
}
.highlight-attribute {
  color: #00c;
}
.highlight-header {
  color: blue;
}
.highlight-quote {
  color: #090;
}
.highlight-link {
  color: #00c;
}
/* apply the same style to codemirror */
.cm-s-ipython span.cm-keyword {
  color: #008000;
  font-weight: bold;
}
.cm-s-ipython span.cm-atom {
  color: #88F;
}
.cm-s-ipython span.cm-number {
  color: #080;
}
.cm-s-ipython span.cm-def {
  color: #00f;
}
.cm-s-ipython span.cm-variable {
  color: #000;
}
.cm-s-ipython span.cm-operator {
  color: #AA22FF;
  font-weight: bold;
}
.cm-s-ipython span.cm-variable-2 {
  color: #1a1a1a;
}
.cm-s-ipython span.cm-variable-3 {
  color: #333333;
}
.cm-s-ipython span.cm-comment {
  color: #408080;
  font-style: italic;
}
.cm-s-ipython span.cm-string {
  color: #BA2121;
}
.cm-s-ipython span.cm-string-2 {
  color: #f50;
}
.cm-s-ipython span.cm-meta {
  color: #AA22FF;
}
.cm-s-ipython span.cm-qualifier {
  color: #555;
}
.cm-s-ipython span.cm-builtin {
  color: #008000;
}
.cm-s-ipython span.cm-bracket {
  color: #997;
}
.cm-s-ipython span.cm-tag {
  color: #170;
}
.cm-s-ipython span.cm-attribute {
  color: #00c;
}
.cm-s-ipython span.cm-header {
  color: blue;
}
.cm-s-ipython span.cm-quote {
  color: #090;
}
.cm-s-ipython span.cm-link {
  color: #00c;
}
.cm-s-ipython span.cm-error {
  color: #f00;
}
.cm-s-ipython span.cm-tab {
  background: url(data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAADAAAAAMCAYAAAAkuj5RAAAAAXNSR0IArs4c6QAAAGFJREFUSMft1LsRQFAQheHPowAKoACx3IgEKtaEHujDjORSgWTH/ZOdnZOcM/sgk/kFFWY0qV8foQwS4MKBCS3qR6ixBJvElOobYAtivseIE120FaowJPN75GMu8j/LfMwNjh4HUpwg4LUAAAAASUVORK5CYII=);
  background-position: right;
  background-repeat: no-repeat;
}
div.output_wrapper {
  /* this position must be relative to enable descendents to be absolute within it */
  position: relative;
  /* Old browsers */
  display: -webkit-box;
  -webkit-box-orient: vertical;
  -webkit-box-align: stretch;
  display: -moz-box;
  -moz-box-orient: vertical;
  -moz-box-align: stretch;
  display: box;
  box-orient: vertical;
  box-align: stretch;
  /* Modern browsers */
  display: flex;
  flex-direction: column;
  align-items: stretch;
  z-index: 1;
}
/* class for the output area when it should be height-limited */
div.output_scroll {
  /* ideally, this would be max-height, but FF barfs all over that */
  height: 24em;
  /* FF needs this *and the wrapper* to specify full width, or it will shrinkwrap */
  width: 100%;
  overflow: auto;
  border-radius: 2px;
  -webkit-box-shadow: inset 0 2px 8px rgba(0, 0, 0, 0.8);
  box-shadow: inset 0 2px 8px rgba(0, 0, 0, 0.8);
  display: block;
}
/* output div while it is collapsed */
div.output_collapsed {
  margin: 0px;
  padding: 0px;
  /* Old browsers */
  display: -webkit-box;
  -webkit-box-orient: vertical;
  -webkit-box-align: stretch;
  display: -moz-box;
  -moz-box-orient: vertical;
  -moz-box-align: stretch;
  display: box;
  box-orient: vertical;
  box-align: stretch;
  /* Modern browsers */
  display: flex;
  flex-direction: column;
  align-items: stretch;
}
div.out_prompt_overlay {
  height: 100%;
  padding: 0px 0.4em;
  position: absolute;
  border-radius: 2px;
}
div.out_prompt_overlay:hover {
  /* use inner shadow to get border that is computed the same on WebKit/FF */
  -webkit-box-shadow: inset 0 0 1px #000;
  box-shadow: inset 0 0 1px #000;
  background: rgba(240, 240, 240, 0.5);
}
div.output_prompt {
  color: #D84315;
}
/* This class is the outer container of all output sections. */
div.output_area {
  padding: 0px;
  page-break-inside: avoid;
  /* Old browsers */
  display: -webkit-box;
  -webkit-box-orient: horizontal;
  -webkit-box-align: stretch;
  display: -moz-box;
  -moz-box-orient: horizontal;
  -moz-box-align: stretch;
  display: box;
  box-orient: horizontal;
  box-align: stretch;
  /* Modern browsers */
  display: flex;
  flex-direction: row;
  align-items: stretch;
}
div.output_area .MathJax_Display {
  text-align: left !important;
}
div.output_area 
div.output_area 
div.output_area img,
div.output_area svg {
  max-width: 100%;
  height: auto;
}
div.output_area img.unconfined,
div.output_area svg.unconfined {
  max-width: none;
}
/* This is needed to protect the pre formating from global settings such
   as that of bootstrap */
.output {
  /* Old browsers */
  display: -webkit-box;
  -webkit-box-orient: vertical;
  -webkit-box-align: stretch;
  display: -moz-box;
  -moz-box-orient: vertical;
  -moz-box-align: stretch;
  display: box;
  box-orient: vertical;
  box-align: stretch;
  /* Modern browsers */
  display: flex;
  flex-direction: column;
  align-items: stretch;
}
@media (max-width: 540px) {
  div.output_area {
    /* Old browsers */
    display: -webkit-box;
    -webkit-box-orient: vertical;
    -webkit-box-align: stretch;
    display: -moz-box;
    -moz-box-orient: vertical;
    -moz-box-align: stretch;
    display: box;
    box-orient: vertical;
    box-align: stretch;
    /* Modern browsers */
    display: flex;
    flex-direction: column;
    align-items: stretch;
  }
}
div.output_area pre {
  margin: 0;
  padding: 0;
  border: 0;
  vertical-align: baseline;
  color: black;
  background-color: transparent;
  border-radius: 0;
}
/* This class is for the output subarea inside the output_area and after
   the prompt div. */
div.output_subarea {
  overflow-x: auto;
  padding: 0.4em;
  /* Old browsers */
  -webkit-box-flex: 1;
  -moz-box-flex: 1;
  box-flex: 1;
  /* Modern browsers */
  flex: 1;
  max-width: calc(100% - 14ex);
}
div.output_scroll div.output_subarea {
  overflow-x: visible;
}
/* The rest of the output_* classes are for special styling of the different
   output types */
/* all text output has this class: */
div.output_text {
  text-align: left;
  color: #000;
  /* This has to match that of the the CodeMirror class line-height below */
  line-height: 1.21429em;
}
/* stdout/stderr are 'text' as well as 'stream', but execute_result/error are *not* streams */
div.output_stderr {
  background: #fdd;
  /* very light red background for stderr */
}
div.output_latex {
  text-align: left;
}
/* Empty output_javascript divs should have no height */
div.output_javascript:empty {
  padding: 0;
}
.js-error {
  color: darkred;
}
/* raw_input styles */
div.raw_input_container {
  line-height: 1.21429em;
  padding-top: 5px;
}
pre.raw_input_prompt {
  /* nothing needed here. */
}
input.raw_input {
  font-family: monospace;
  font-size: inherit;
  color: inherit;
  width: auto;
  /* make sure input baseline aligns with prompt */
  vertical-align: baseline;
  /* padding + margin = 0.5em between prompt and cursor */
  padding: 0em 0.25em;
  margin: 0em 0.25em;
}
input.raw_input:focus {
  box-shadow: none;
}
p.p-space {
  margin-bottom: 10px;
}
div.output_unrecognized {
  padding: 5px;
  font-weight: bold;
  color: red;
}
div.output_unrecognized a {
  color: inherit;
  text-decoration: none;
}
div.output_unrecognized a:hover {
  color: inherit;
  text-decoration: none;
}
.rendered_html {
  color: #000;
  /* any extras will just be numbers: */
}



.rendered_html :link {
  text-decoration: underline;
}
.rendered_html :visited {
  text-decoration: underline;
}






.rendered_html h1:first-child {
  margin-top: 0.538em;
}
.rendered_html h2:first-child {
  margin-top: 0.636em;
}
.rendered_html h3:first-child {
  margin-top: 0.777em;
}
.rendered_html h4:first-child {
  margin-top: 1em;
}
.rendered_html h5:first-child {
  margin-top: 1em;
}
.rendered_html h6:first-child {
  margin-top: 1em;
}








.rendered_html * + ul {
  margin-top: 1em;
}
.rendered_html * + ol {
  margin-top: 1em;
}


.rendered_html pre,



.rendered_html tr,
.rendered_html th,

.rendered_html td,


.rendered_html * + table {
  margin-top: 1em;
}

.rendered_html * + p {
  margin-top: 1em;
}

.rendered_html * + img {
  margin-top: 1em;
}
.rendered_html img,

.rendered_html img.unconfined,

div.text_cell {
  /* Old browsers */
  display: -webkit-box;
  -webkit-box-orient: horizontal;
  -webkit-box-align: stretch;
  display: -moz-box;
  -moz-box-orient: horizontal;
  -moz-box-align: stretch;
  display: box;
  box-orient: horizontal;
  box-align: stretch;
  /* Modern browsers */
  display: flex;
  flex-direction: row;
  align-items: stretch;
}
@media (max-width: 540px) {
  div.text_cell > div.prompt {
    display: none;
  }
}
div.text_cell_render {
  /*font-family: "Helvetica Neue", Arial, Helvetica, Geneva, sans-serif;*/
  outline: none;
  resize: none;
  width: inherit;
  border-style: none;
  padding: 0.5em 0.5em 0.5em 0.4em;
  color: #000;
  box-sizing: border-box;
  -moz-box-sizing: border-box;
  -webkit-box-sizing: border-box;
}
a.anchor-link:link {
  text-decoration: none;
  padding: 0px 20px;
  visibility: hidden;
}
h1:hover .anchor-link,
h2:hover .anchor-link,
h3:hover .anchor-link,
h4:hover .anchor-link,
h5:hover .anchor-link,
h6:hover .anchor-link {
  visibility: visible;
}
.text_cell.rendered .input_area {
  display: none;
}
.text_cell.rendered 
.text_cell.unrendered .text_cell_render {
  display: none;
}
.cm-header-1,
.cm-header-2,
.cm-header-3,
.cm-header-4,
.cm-header-5,
.cm-header-6 {
  font-weight: bold;
  font-family: "Helvetica Neue", Helvetica, Arial, sans-serif;
}
.cm-header-1 {
  font-size: 185.7%;
}
.cm-header-2 {
  font-size: 157.1%;
}
.cm-header-3 {
  font-size: 128.6%;
}
.cm-header-4 {
  font-size: 110%;
}
.cm-header-5 {
  font-size: 100%;
  font-style: italic;
}
.cm-header-6 {
  font-size: 100%;
  font-style: italic;
}
</style>
<style type="text/css">.highlight .hll { background-color: #ffffcc }
.highlight  { background: #f8f8f8; }
.highlight .c { color: #408080; font-style: italic } /* Comment */
.highlight .err { border: 1px solid #FF0000 } /* Error */
.highlight .k { color: #008000; font-weight: bold } /* Keyword */
.highlight .o { color: #666666 } /* Operator */
.highlight .ch { color: #408080; font-style: italic } /* Comment.Hashbang */
.highlight .cm { color: #408080; font-style: italic } /* Comment.Multiline */
.highlight .cp { color: #BC7A00 } /* Comment.Preproc */
.highlight .cpf { color: #408080; font-style: italic } /* Comment.PreprocFile */
.highlight .c1 { color: #408080; font-style: italic } /* Comment.Single */
.highlight .cs { color: #408080; font-style: italic } /* Comment.Special */
.highlight .gd { color: #A00000 } /* Generic.Deleted */
.highlight .ge { font-style: italic } /* Generic.Emph */
.highlight .gr { color: #FF0000 } /* Generic.Error */
.highlight .gh { color: #000080; font-weight: bold } /* Generic.Heading */
.highlight .gi { color: #00A000 } /* Generic.Inserted */
.highlight .go { color: #888888 } /* Generic.Output */
.highlight .gp { color: #000080; font-weight: bold } /* Generic.Prompt */
.highlight .gs { font-weight: bold } /* Generic.Strong */
.highlight .gu { color: #800080; font-weight: bold } /* Generic.Subheading */
.highlight .gt { color: #0044DD } /* Generic.Traceback */
.highlight .kc { color: #008000; font-weight: bold } /* Keyword.Constant */
.highlight .kd { color: #008000; font-weight: bold } /* Keyword.Declaration */
.highlight .kn { color: #008000; font-weight: bold } /* Keyword.Namespace */
.highlight .kp { color: #008000 } /* Keyword.Pseudo */
.highlight .kr { color: #008000; font-weight: bold } /* Keyword.Reserved */
.highlight .kt { color: #B00040 } /* Keyword.Type */
.highlight .m { color: #666666 } /* Literal.Number */
.highlight .s { color: #BA2121 } /* Literal.String */
.highlight .na { color: #7D9029 } /* Name.Attribute */
.highlight .nb { color: #008000 } /* Name.Builtin */
.highlight .nc { color: #0000FF; font-weight: bold } /* Name.Class */
.highlight .no { color: #880000 } /* Name.Constant */
.highlight .nd { color: #AA22FF } /* Name.Decorator */
.highlight .ni { color: #999999; font-weight: bold } /* Name.Entity */
.highlight .ne { color: #D2413A; font-weight: bold } /* Name.Exception */
.highlight .nf { color: #0000FF } /* Name.Function */
.highlight .nl { color: #A0A000 } /* Name.Label */
.highlight .nn { color: #0000FF; font-weight: bold } /* Name.Namespace */
.highlight .nt { color: #008000; font-weight: bold } /* Name.Tag */
.highlight .nv { color: #19177C } /* Name.Variable */
.highlight .ow { color: #AA22FF; font-weight: bold } /* Operator.Word */
.highlight .w { color: #bbbbbb } /* Text.Whitespace */
.highlight .mb { color: #666666 } /* Literal.Number.Bin */
.highlight .mf { color: #666666 } /* Literal.Number.Float */
.highlight .mh { color: #666666 } /* Literal.Number.Hex */
.highlight .mi { color: #666666 } /* Literal.Number.Integer */
.highlight .mo { color: #666666 } /* Literal.Number.Oct */
.highlight .sa { color: #BA2121 } /* Literal.String.Affix */
.highlight .sb { color: #BA2121 } /* Literal.String.Backtick */
.highlight .sc { color: #BA2121 } /* Literal.String.Char */
.highlight .dl { color: #BA2121 } /* Literal.String.Delimiter */
.highlight .sd { color: #BA2121; font-style: italic } /* Literal.String.Doc */
.highlight .s2 { color: #BA2121 } /* Literal.String.Double */
.highlight .se { color: #BB6622; font-weight: bold } /* Literal.String.Escape */
.highlight .sh { color: #BA2121 } /* Literal.String.Heredoc */
.highlight .si { color: #BB6688; font-weight: bold } /* Literal.String.Interpol */
.highlight .sx { color: #008000 } /* Literal.String.Other */
.highlight .sr { color: #BB6688 } /* Literal.String.Regex */
.highlight .s1 { color: #BA2121 } /* Literal.String.Single */
.highlight .ss { color: #19177C } /* Literal.String.Symbol */
.highlight .bp { color: #008000 } /* Name.Builtin.Pseudo */
.highlight .fm { color: #0000FF } /* Name.Function.Magic */
.highlight .vc { color: #19177C } /* Name.Variable.Class */
.highlight .vg { color: #19177C } /* Name.Variable.Global */
.highlight .vi { color: #19177C } /* Name.Variable.Instance */
.highlight .vm { color: #19177C } /* Name.Variable.Magic */
.highlight .il { color: #666666 } /* Literal.Number.Integer.Long */</style>
<style type="text/css">
/* Temporary definitions which will become obsolete with Notebook release 5.0 */
.ansi-black-fg { color: #3E424D; }
.ansi-black-bg { background-color: #3E424D; }
.ansi-black-intense-fg { color: #282C36; }
.ansi-black-intense-bg { background-color: #282C36; }
.ansi-red-fg { color: #E75C58; }
.ansi-red-bg { background-color: #E75C58; }
.ansi-red-intense-fg { color: #B22B31; }
.ansi-red-intense-bg { background-color: #B22B31; }
.ansi-green-fg { color: #00A250; }
.ansi-green-bg { background-color: #00A250; }
.ansi-green-intense-fg { color: #007427; }
.ansi-green-intense-bg { background-color: #007427; }
.ansi-yellow-fg { color: #DDB62B; }
.ansi-yellow-bg { background-color: #DDB62B; }
.ansi-yellow-intense-fg { color: #B27D12; }
.ansi-yellow-intense-bg { background-color: #B27D12; }
.ansi-blue-fg { color: #208FFB; }
.ansi-blue-bg { background-color: #208FFB; }
.ansi-blue-intense-fg { color: #0065CA; }
.ansi-blue-intense-bg { background-color: #0065CA; }
.ansi-magenta-fg { color: #D160C4; }
.ansi-magenta-bg { background-color: #D160C4; }
.ansi-magenta-intense-fg { color: #A03196; }
.ansi-magenta-intense-bg { background-color: #A03196; }
.ansi-cyan-fg { color: #60C6C8; }
.ansi-cyan-bg { background-color: #60C6C8; }
.ansi-cyan-intense-fg { color: #258F8F; }
.ansi-cyan-intense-bg { background-color: #258F8F; }
.ansi-white-fg { color: #C5C1B4; }
.ansi-white-bg { background-color: #C5C1B4; }
.ansi-white-intense-fg { color: #A1A6B2; }
.ansi-white-intense-bg { background-color: #A1A6B2; }

.ansi-bold { font-weight: bold; }
</style>
<div class="cell border-box-sizing code_cell rendered">
<div class="input">
<div class="prompt input_prompt">In&nbsp;[1]:</div>
<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>
<span class="kn">import</span> <span class="nn">requests</span>
<span class="kn">import</span> <span class="nn">skimage</span>
<span class="kn">import</span> <span class="nn">skimage.data</span>
<span class="kn">import</span> <span class="nn">sonnet</span> <span class="k">as</span> <span class="nn">snt</span>
<span class="kn">import</span> <span class="nn">tensorflow</span> <span class="k">as</span> <span class="nn">tf</span>
<span class="kn">import</span> <span class="nn">ipywidgets</span> <span class="k">as</span> <span class="nn">widgets</span>
<span class="kn">import</span> <span class="nn">matplotlib.pyplot</span> <span class="k">as</span> <span class="nn">plt</span>

<span class="n">keras</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">keras</span>
<span class="n">K</span> <span class="o">=</span> <span class="n">keras</span><span class="o">.</span><span class="n">backend</span>

<span class="kn">from</span> <span class="nn">ipywidgets</span> <span class="k">import</span> <span class="n">interact</span><span class="p">,</span> <span class="n">interactive</span><span class="p">,</span> <span class="n">Layout</span><span class="p">,</span> <span class="n">HBox</span>
<span class="kn">from</span> <span class="nn">skimage.transform</span> <span class="k">import</span> <span class="n">rescale</span><span class="p">,</span> <span class="n">warp</span><span class="p">,</span> <span class="n">ProjectiveTransform</span>
<span class="kn">from</span> <span class="nn">sklearn.preprocessing</span> <span class="k">import</span> <span class="n">OneHotEncoder</span>

<span class="c1"># extra code</span>
<span class="kn">import</span> <span class="nn">helpers</span>

<span class="kn">import</span> <span class="nn">matplotlib</span>
<span class="n">matplotlib</span><span class="o">.</span><span class="n">rcParams</span><span class="o">.</span><span class="n">update</span><span class="p">({</span><span class="s1">&#39;font.size&#39;</span><span class="p">:</span> <span class="mi">18</span><span class="p">})</span>
</pre></div>

</div>
</div>
</div>

<div class="output_wrapper">
<div class="output">


<div class="output_area">

<div class="prompt"></div>


<div class="output_subarea output_text output_error">
<pre>
<span class="ansi-red-fg">---------------------------------------------------------------------------</span>
<span class="ansi-red-fg">KeyboardInterrupt</span>                         Traceback (most recent call last)
<span class="ansi-green-fg">&lt;ipython-input-1-766302b79883&gt;</span> in <span class="ansi-cyan-fg">&lt;module&gt;</span>
<span class="ansi-green-intense-fg ansi-bold">      3</span> <span class="ansi-green-fg">import</span> skimage
<span class="ansi-green-intense-fg ansi-bold">      4</span> <span class="ansi-green-fg">import</span> skimage<span class="ansi-blue-fg">.</span>data
<span class="ansi-green-fg">----&gt; 5</span><span class="ansi-red-fg"> </span><span class="ansi-green-fg">import</span> sonnet <span class="ansi-green-fg">as</span> snt
<span class="ansi-green-intense-fg ansi-bold">      6</span> <span class="ansi-green-fg">import</span> tensorflow <span class="ansi-green-fg">as</span> tf
<span class="ansi-green-intense-fg ansi-bold">      7</span> <span class="ansi-green-fg">import</span> ipywidgets <span class="ansi-green-fg">as</span> widgets

<span class="ansi-green-fg">~/anaconda3/envs/tf/lib/python3.6/site-packages/sonnet/__init__.py</span> in <span class="ansi-cyan-fg">&lt;module&gt;</span>
<span class="ansi-green-intense-fg ansi-bold">     62</span> 
<span class="ansi-green-intense-fg ansi-bold">     63</span> _ensure_dependency_available_at_version<span class="ansi-blue-fg">(</span><span class="ansi-blue-fg">&#39;tensorflow&#39;</span><span class="ansi-blue-fg">,</span> <span class="ansi-blue-fg">&#39;1.8.0&#39;</span><span class="ansi-blue-fg">)</span>
<span class="ansi-green-fg">---&gt; 64</span><span class="ansi-red-fg"> </span>_ensure_dependency_available_at_version<span class="ansi-blue-fg">(</span><span class="ansi-blue-fg">&#39;tensorflow_probability&#39;</span><span class="ansi-blue-fg">,</span> <span class="ansi-blue-fg">&#39;0.4.0&#39;</span><span class="ansi-blue-fg">)</span>
<span class="ansi-green-intense-fg ansi-bold">     65</span> 
<span class="ansi-green-intense-fg ansi-bold">     66</span> <span class="ansi-red-fg"># Check some version of TF is available.</span>

<span class="ansi-green-fg">~/anaconda3/envs/tf/lib/python3.6/site-packages/sonnet/__init__.py</span> in <span class="ansi-cyan-fg">_ensure_dependency_available_at_version</span><span class="ansi-blue-fg">(package_name, min_version)</span>
<span class="ansi-green-intense-fg ansi-bold">     45</span> 
<span class="ansi-green-intense-fg ansi-bold">     46</span>   <span class="ansi-green-fg">try</span><span class="ansi-blue-fg">:</span>
<span class="ansi-green-fg">---&gt; 47</span><span class="ansi-red-fg">     </span>pkg <span class="ansi-blue-fg">=</span> importlib<span class="ansi-blue-fg">.</span>import_module<span class="ansi-blue-fg">(</span>package_name<span class="ansi-blue-fg">)</span>
<span class="ansi-green-intense-fg ansi-bold">     48</span>   <span class="ansi-green-fg">except</span> ImportError<span class="ansi-blue-fg">:</span>
<span class="ansi-green-intense-fg ansi-bold">     49</span>     pip_name <span class="ansi-blue-fg">=</span> package_name<span class="ansi-blue-fg">.</span>replace<span class="ansi-blue-fg">(</span><span class="ansi-blue-fg">&#39;_&#39;</span><span class="ansi-blue-fg">,</span> <span class="ansi-blue-fg">&#39;-&#39;</span><span class="ansi-blue-fg">)</span>

<span class="ansi-green-fg">~/anaconda3/envs/tf/lib/python3.6/importlib/__init__.py</span> in <span class="ansi-cyan-fg">import_module</span><span class="ansi-blue-fg">(name, package)</span>
<span class="ansi-green-intense-fg ansi-bold">    124</span>                 <span class="ansi-green-fg">break</span>
<span class="ansi-green-intense-fg ansi-bold">    125</span>             level <span class="ansi-blue-fg">+=</span> <span class="ansi-cyan-fg">1</span>
<span class="ansi-green-fg">--&gt; 126</span><span class="ansi-red-fg">     </span><span class="ansi-green-fg">return</span> _bootstrap<span class="ansi-blue-fg">.</span>_gcd_import<span class="ansi-blue-fg">(</span>name<span class="ansi-blue-fg">[</span>level<span class="ansi-blue-fg">:</span><span class="ansi-blue-fg">]</span><span class="ansi-blue-fg">,</span> package<span class="ansi-blue-fg">,</span> level<span class="ansi-blue-fg">)</span>
<span class="ansi-green-intense-fg ansi-bold">    127</span> 
<span class="ansi-green-intense-fg ansi-bold">    128</span> 

<span class="ansi-green-fg">~/anaconda3/envs/tf/lib/python3.6/site-packages/tensorflow_probability/__init__.py</span> in <span class="ansi-cyan-fg">&lt;module&gt;</span>
<span class="ansi-green-intense-fg ansi-bold">     76</span> 
<span class="ansi-green-intense-fg ansi-bold">     77</span> <span class="ansi-red-fg"># from tensorflow_probability.google import staging  # DisableOnExport</span>
<span class="ansi-green-fg">---&gt; 78</span><span class="ansi-red-fg"> </span><span class="ansi-green-fg">from</span> tensorflow_probability<span class="ansi-blue-fg">.</span>python <span class="ansi-green-fg">import</span> <span class="ansi-blue-fg">*</span>  <span class="ansi-red-fg"># pylint: disable=wildcard-import</span>
<span class="ansi-green-intense-fg ansi-bold">     79</span> <span class="ansi-green-fg">from</span> tensorflow_probability<span class="ansi-blue-fg">.</span>python<span class="ansi-blue-fg">.</span>version <span class="ansi-green-fg">import</span> __version__
<span class="ansi-green-intense-fg ansi-bold">     80</span> <span class="ansi-red-fg"># pylint: enable=g-import-not-at-top</span>

<span class="ansi-green-fg">~/anaconda3/envs/tf/lib/python3.6/site-packages/tensorflow_probability/python/__init__.py</span> in <span class="ansi-cyan-fg">&lt;module&gt;</span>
<span class="ansi-green-intense-fg ansi-bold">     19</span> <span class="ansi-green-fg">from</span> __future__ <span class="ansi-green-fg">import</span> print_function
<span class="ansi-green-intense-fg ansi-bold">     20</span> 
<span class="ansi-green-fg">---&gt; 21</span><span class="ansi-red-fg"> </span><span class="ansi-green-fg">from</span> tensorflow_probability<span class="ansi-blue-fg">.</span>python <span class="ansi-green-fg">import</span> bijectors
<span class="ansi-green-intense-fg ansi-bold">     22</span> <span class="ansi-green-fg">from</span> tensorflow_probability<span class="ansi-blue-fg">.</span>python <span class="ansi-green-fg">import</span> distributions
<span class="ansi-green-intense-fg ansi-bold">     23</span> <span class="ansi-green-fg">from</span> tensorflow_probability<span class="ansi-blue-fg">.</span>python <span class="ansi-green-fg">import</span> edward2

<span class="ansi-green-fg">~/anaconda3/envs/tf/lib/python3.6/site-packages/tensorflow_probability/python/bijectors/__init__.py</span> in <span class="ansi-cyan-fg">&lt;module&gt;</span>
<span class="ansi-green-intense-fg ansi-bold">     21</span> <span class="ansi-red-fg"># pylint: disable=unused-import,wildcard-import,line-too-long,g-importing-member</span>
<span class="ansi-green-intense-fg ansi-bold">     22</span> 
<span class="ansi-green-fg">---&gt; 23</span><span class="ansi-red-fg"> </span><span class="ansi-green-fg">from</span> tensorflow_probability<span class="ansi-blue-fg">.</span>python<span class="ansi-blue-fg">.</span>bijectors<span class="ansi-blue-fg">.</span>absolute_value <span class="ansi-green-fg">import</span> AbsoluteValue
<span class="ansi-green-intense-fg ansi-bold">     24</span> <span class="ansi-green-fg">from</span> tensorflow_probability<span class="ansi-blue-fg">.</span>python<span class="ansi-blue-fg">.</span>bijectors<span class="ansi-blue-fg">.</span>affine <span class="ansi-green-fg">import</span> Affine
<span class="ansi-green-intense-fg ansi-bold">     25</span> <span class="ansi-green-fg">from</span> tensorflow_probability<span class="ansi-blue-fg">.</span>python<span class="ansi-blue-fg">.</span>bijectors<span class="ansi-blue-fg">.</span>affine_linear_operator <span class="ansi-green-fg">import</span> AffineLinearOperator

<span class="ansi-green-fg">~/anaconda3/envs/tf/lib/python3.6/site-packages/tensorflow_probability/python/bijectors/absolute_value.py</span> in <span class="ansi-cyan-fg">&lt;module&gt;</span>
<span class="ansi-green-intense-fg ansi-bold">     20</span> 
<span class="ansi-green-intense-fg ansi-bold">     21</span> <span class="ansi-green-fg">import</span> tensorflow <span class="ansi-green-fg">as</span> tf
<span class="ansi-green-fg">---&gt; 22</span><span class="ansi-red-fg"> </span><span class="ansi-green-fg">from</span> tensorflow_probability<span class="ansi-blue-fg">.</span>python<span class="ansi-blue-fg">.</span>bijectors <span class="ansi-green-fg">import</span> bijector
<span class="ansi-green-intense-fg ansi-bold">     23</span> <span class="ansi-green-fg">from</span> tensorflow<span class="ansi-blue-fg">.</span>python<span class="ansi-blue-fg">.</span>ops <span class="ansi-green-fg">import</span> control_flow_ops
<span class="ansi-green-intense-fg ansi-bold">     24</span> 

<span class="ansi-green-fg">~/anaconda3/envs/tf/lib/python3.6/site-packages/tensorflow_probability/python/bijectors/bijector.py</span> in <span class="ansi-cyan-fg">&lt;module&gt;</span>
<span class="ansi-green-intense-fg ansi-bold">     29</span> <span class="ansi-green-fg">import</span> tensorflow <span class="ansi-green-fg">as</span> tf
<span class="ansi-green-intense-fg ansi-bold">     30</span> 
<span class="ansi-green-fg">---&gt; 31</span><span class="ansi-red-fg"> </span><span class="ansi-green-fg">from</span> tensorflow_probability<span class="ansi-blue-fg">.</span>python<span class="ansi-blue-fg">.</span>internal <span class="ansi-green-fg">import</span> distribution_util
<span class="ansi-green-intense-fg ansi-bold">     32</span> <span class="ansi-green-fg">from</span> tensorflow<span class="ansi-blue-fg">.</span>python<span class="ansi-blue-fg">.</span>framework <span class="ansi-green-fg">import</span> tensor_util
<span class="ansi-green-intense-fg ansi-bold">     33</span> 

<span class="ansi-green-fg">~/anaconda3/envs/tf/lib/python3.6/site-packages/tensorflow_probability/python/internal/distribution_util.py</span> in <span class="ansi-cyan-fg">&lt;module&gt;</span>
<span class="ansi-green-intense-fg ansi-bold">     24</span> <span class="ansi-green-fg">import</span> tensorflow <span class="ansi-green-fg">as</span> tf
<span class="ansi-green-intense-fg ansi-bold">     25</span> 
<span class="ansi-green-fg">---&gt; 26</span><span class="ansi-red-fg"> </span><span class="ansi-green-fg">from</span> tensorflow_probability<span class="ansi-blue-fg">.</span>python<span class="ansi-blue-fg">.</span>internal <span class="ansi-green-fg">import</span> dtype_util
<span class="ansi-green-intense-fg ansi-bold">     27</span> <span class="ansi-green-fg">from</span> tensorflow_probability<span class="ansi-blue-fg">.</span>python<span class="ansi-blue-fg">.</span>internal <span class="ansi-green-fg">import</span> reparameterization
<span class="ansi-green-intense-fg ansi-bold">     28</span> <span class="ansi-green-fg">from</span> tensorflow<span class="ansi-blue-fg">.</span>python<span class="ansi-blue-fg">.</span>framework <span class="ansi-green-fg">import</span> smart_cond

<span class="ansi-green-fg">~/anaconda3/envs/tf/lib/python3.6/site-packages/tensorflow_probability/python/internal/dtype_util.py</span> in <span class="ansi-cyan-fg">&lt;module&gt;</span>
<span class="ansi-green-intense-fg ansi-bold">     22</span> <span class="ansi-green-fg">import</span> tensorflow <span class="ansi-green-fg">as</span> tf
<span class="ansi-green-intense-fg ansi-bold">     23</span> 
<span class="ansi-green-fg">---&gt; 24</span><span class="ansi-red-fg"> </span><span class="ansi-green-fg">from</span> tensorflow<span class="ansi-blue-fg">.</span>contrib <span class="ansi-green-fg">import</span> framework <span class="ansi-green-fg">as</span> contrib_framework
<span class="ansi-green-intense-fg ansi-bold">     25</span> 
<span class="ansi-green-intense-fg ansi-bold">     26</span> 

<span class="ansi-green-fg">~/anaconda3/envs/tf/lib/python3.6/site-packages/tensorflow/contrib/__init__.py</span> in <span class="ansi-cyan-fg">&lt;module&gt;</span>
<span class="ansi-green-intense-fg ansi-bold">     47</span> <span class="ansi-green-fg">from</span> tensorflow<span class="ansi-blue-fg">.</span>contrib <span class="ansi-green-fg">import</span> deprecated
<span class="ansi-green-intense-fg ansi-bold">     48</span> <span class="ansi-green-fg">from</span> tensorflow<span class="ansi-blue-fg">.</span>contrib <span class="ansi-green-fg">import</span> distribute
<span class="ansi-green-fg">---&gt; 49</span><span class="ansi-red-fg"> </span><span class="ansi-green-fg">from</span> tensorflow<span class="ansi-blue-fg">.</span>contrib <span class="ansi-green-fg">import</span> distributions
<span class="ansi-green-intense-fg ansi-bold">     50</span> <span class="ansi-green-fg">from</span> tensorflow<span class="ansi-blue-fg">.</span>contrib <span class="ansi-green-fg">import</span> estimator
<span class="ansi-green-intense-fg ansi-bold">     51</span> <span class="ansi-green-fg">from</span> tensorflow<span class="ansi-blue-fg">.</span>contrib <span class="ansi-green-fg">import</span> factorization

<span class="ansi-green-fg">~/anaconda3/envs/tf/lib/python3.6/site-packages/tensorflow/contrib/distributions/__init__.py</span> in <span class="ansi-cyan-fg">&lt;module&gt;</span>
<span class="ansi-green-intense-fg ansi-bold">     36</span> <span class="ansi-green-fg">from</span> tensorflow<span class="ansi-blue-fg">.</span>contrib<span class="ansi-blue-fg">.</span>distributions<span class="ansi-blue-fg">.</span>python<span class="ansi-blue-fg">.</span>ops<span class="ansi-blue-fg">.</span>distribution_util <span class="ansi-green-fg">import</span> softplus_inverse
<span class="ansi-green-intense-fg ansi-bold">     37</span> <span class="ansi-green-fg">from</span> tensorflow<span class="ansi-blue-fg">.</span>contrib<span class="ansi-blue-fg">.</span>distributions<span class="ansi-blue-fg">.</span>python<span class="ansi-blue-fg">.</span>ops<span class="ansi-blue-fg">.</span>distribution_util <span class="ansi-green-fg">import</span> tridiag
<span class="ansi-green-fg">---&gt; 38</span><span class="ansi-red-fg"> </span><span class="ansi-green-fg">from</span> tensorflow<span class="ansi-blue-fg">.</span>contrib<span class="ansi-blue-fg">.</span>distributions<span class="ansi-blue-fg">.</span>python<span class="ansi-blue-fg">.</span>ops<span class="ansi-blue-fg">.</span>estimator <span class="ansi-green-fg">import</span> <span class="ansi-blue-fg">*</span>
<span class="ansi-green-intense-fg ansi-bold">     39</span> <span class="ansi-green-fg">from</span> tensorflow<span class="ansi-blue-fg">.</span>contrib<span class="ansi-blue-fg">.</span>distributions<span class="ansi-blue-fg">.</span>python<span class="ansi-blue-fg">.</span>ops<span class="ansi-blue-fg">.</span>geometric <span class="ansi-green-fg">import</span> <span class="ansi-blue-fg">*</span>
<span class="ansi-green-intense-fg ansi-bold">     40</span> <span class="ansi-green-fg">from</span> tensorflow<span class="ansi-blue-fg">.</span>contrib<span class="ansi-blue-fg">.</span>distributions<span class="ansi-blue-fg">.</span>python<span class="ansi-blue-fg">.</span>ops<span class="ansi-blue-fg">.</span>half_normal <span class="ansi-green-fg">import</span> <span class="ansi-blue-fg">*</span>

<span class="ansi-green-fg">~/anaconda3/envs/tf/lib/python3.6/site-packages/tensorflow/contrib/distributions/python/ops/estimator.py</span> in <span class="ansi-cyan-fg">&lt;module&gt;</span>
<span class="ansi-green-intense-fg ansi-bold">     19</span> <span class="ansi-green-fg">from</span> __future__ <span class="ansi-green-fg">import</span> print_function
<span class="ansi-green-intense-fg ansi-bold">     20</span> 
<span class="ansi-green-fg">---&gt; 21</span><span class="ansi-red-fg"> </span><span class="ansi-green-fg">from</span> tensorflow<span class="ansi-blue-fg">.</span>contrib<span class="ansi-blue-fg">.</span>learn<span class="ansi-blue-fg">.</span>python<span class="ansi-blue-fg">.</span>learn<span class="ansi-blue-fg">.</span>estimators<span class="ansi-blue-fg">.</span>head <span class="ansi-green-fg">import</span> _compute_weighted_loss
<span class="ansi-green-intense-fg ansi-bold">     22</span> <span class="ansi-green-fg">from</span> tensorflow<span class="ansi-blue-fg">.</span>contrib<span class="ansi-blue-fg">.</span>learn<span class="ansi-blue-fg">.</span>python<span class="ansi-blue-fg">.</span>learn<span class="ansi-blue-fg">.</span>estimators<span class="ansi-blue-fg">.</span>head <span class="ansi-green-fg">import</span> _RegressionHead
<span class="ansi-green-intense-fg ansi-bold">     23</span> <span class="ansi-green-fg">from</span> tensorflow<span class="ansi-blue-fg">.</span>python<span class="ansi-blue-fg">.</span>framework <span class="ansi-green-fg">import</span> ops

<span class="ansi-green-fg">~/anaconda3/envs/tf/lib/python3.6/site-packages/tensorflow/contrib/learn/__init__.py</span> in <span class="ansi-cyan-fg">&lt;module&gt;</span>
<span class="ansi-green-intense-fg ansi-bold">     94</span> 
<span class="ansi-green-intense-fg ansi-bold">     95</span> <span class="ansi-red-fg"># pylint: disable=wildcard-import</span>
<span class="ansi-green-fg">---&gt; 96</span><span class="ansi-red-fg"> </span><span class="ansi-green-fg">from</span> tensorflow<span class="ansi-blue-fg">.</span>contrib<span class="ansi-blue-fg">.</span>learn<span class="ansi-blue-fg">.</span>python<span class="ansi-blue-fg">.</span>learn <span class="ansi-green-fg">import</span> <span class="ansi-blue-fg">*</span>
<span class="ansi-green-intense-fg ansi-bold">     97</span> <span class="ansi-red-fg"># pylint: enable=wildcard-import</span>
<span class="ansi-green-intense-fg ansi-bold">     98</span> 

<span class="ansi-green-fg">~/anaconda3/envs/tf/lib/python3.6/site-packages/tensorflow/contrib/learn/python/__init__.py</span> in <span class="ansi-cyan-fg">&lt;module&gt;</span>
<span class="ansi-green-intense-fg ansi-bold">     26</span> 
<span class="ansi-green-intense-fg ansi-bold">     27</span> <span class="ansi-red-fg"># pylint: disable=wildcard-import</span>
<span class="ansi-green-fg">---&gt; 28</span><span class="ansi-red-fg"> </span><span class="ansi-green-fg">from</span> tensorflow<span class="ansi-blue-fg">.</span>contrib<span class="ansi-blue-fg">.</span>learn<span class="ansi-blue-fg">.</span>python<span class="ansi-blue-fg">.</span>learn <span class="ansi-green-fg">import</span> <span class="ansi-blue-fg">*</span>
<span class="ansi-green-intense-fg ansi-bold">     29</span> <span class="ansi-red-fg"># pylint: enable=wildcard-import</span>

<span class="ansi-green-fg">~/anaconda3/envs/tf/lib/python3.6/site-packages/tensorflow/contrib/learn/python/learn/__init__.py</span> in <span class="ansi-cyan-fg">&lt;module&gt;</span>
<span class="ansi-green-intense-fg ansi-bold">     26</span> 
<span class="ansi-green-intense-fg ansi-bold">     27</span> <span class="ansi-red-fg"># pylint: disable=wildcard-import</span>
<span class="ansi-green-fg">---&gt; 28</span><span class="ansi-red-fg"> </span><span class="ansi-green-fg">from</span> tensorflow<span class="ansi-blue-fg">.</span>contrib<span class="ansi-blue-fg">.</span>learn<span class="ansi-blue-fg">.</span>python<span class="ansi-blue-fg">.</span>learn <span class="ansi-green-fg">import</span> basic_session_run_hooks
<span class="ansi-green-intense-fg ansi-bold">     29</span> <span class="ansi-green-fg">from</span> tensorflow<span class="ansi-blue-fg">.</span>contrib<span class="ansi-blue-fg">.</span>learn<span class="ansi-blue-fg">.</span>python<span class="ansi-blue-fg">.</span>learn <span class="ansi-green-fg">import</span> datasets
<span class="ansi-green-intense-fg ansi-bold">     30</span> <span class="ansi-green-fg">from</span> tensorflow<span class="ansi-blue-fg">.</span>contrib<span class="ansi-blue-fg">.</span>learn<span class="ansi-blue-fg">.</span>python<span class="ansi-blue-fg">.</span>learn <span class="ansi-green-fg">import</span> estimators

<span class="ansi-green-fg">~/anaconda3/envs/tf/lib/python3.6/site-packages/tensorflow/contrib/learn/python/learn/basic_session_run_hooks.py</span> in <span class="ansi-cyan-fg">&lt;module&gt;</span>
<span class="ansi-green-intense-fg ansi-bold">     35</span>     <span class="ansi-blue-fg">&#39;tf.contrib.learn.basic_session_run_hooks.StopAtStepHook&#39;</span><span class="ansi-blue-fg">,</span>
<span class="ansi-green-intense-fg ansi-bold">     36</span>     <span class="ansi-blue-fg">&#39;tf.train.StopAtStepHook&#39;</span><span class="ansi-blue-fg">,</span>
<span class="ansi-green-fg">---&gt; 37</span><span class="ansi-red-fg">     basic_session_run_hooks.StopAtStepHook)
</span><span class="ansi-green-intense-fg ansi-bold">     38</span> CheckpointSaverHook = deprecated_alias(
<span class="ansi-green-intense-fg ansi-bold">     39</span>     <span class="ansi-blue-fg">&#39;tf.contrib.learn.basic_session_run_hooks.CheckpointSaverHook&#39;</span><span class="ansi-blue-fg">,</span>

<span class="ansi-green-fg">~/anaconda3/envs/tf/lib/python3.6/site-packages/tensorflow/python/util/deprecation.py</span> in <span class="ansi-cyan-fg">deprecated_alias</span><span class="ansi-blue-fg">(deprecated_name, name, func_or_class, warn_once)</span>
<span class="ansi-green-intense-fg ansi-bold">    171</span> 
<span class="ansi-green-intense-fg ansi-bold">    172</span>     <span class="ansi-red-fg"># Make a new class with __init__ wrapped in a warning.</span>
<span class="ansi-green-fg">--&gt; 173</span><span class="ansi-red-fg">     </span><span class="ansi-green-fg">class</span> _NewClass<span class="ansi-blue-fg">(</span>func_or_class<span class="ansi-blue-fg">)</span><span class="ansi-blue-fg">:</span>  <span class="ansi-red-fg"># pylint: disable=missing-docstring</span>
<span class="ansi-green-intense-fg ansi-bold">    174</span>       __doc__ = decorator_utils.add_notice_to_docstring(
<span class="ansi-green-intense-fg ansi-bold">    175</span>           func_or_class<span class="ansi-blue-fg">.</span>__doc__<span class="ansi-blue-fg">,</span> <span class="ansi-blue-fg">&#39;Please use %s instead.&#39;</span> <span class="ansi-blue-fg">%</span> name<span class="ansi-blue-fg">,</span>

<span class="ansi-green-fg">~/anaconda3/envs/tf/lib/python3.6/site-packages/tensorflow/python/util/deprecation.py</span> in <span class="ansi-cyan-fg">_NewClass</span><span class="ansi-blue-fg">()</span>
<span class="ansi-green-intense-fg ansi-bold">    178</span>                            &#39;It will be removed in a future version. &#39;])
<span class="ansi-green-intense-fg ansi-bold">    179</span>       __name__ <span class="ansi-blue-fg">=</span> func_or_class<span class="ansi-blue-fg">.</span>__name__
<span class="ansi-green-fg">--&gt; 180</span><span class="ansi-red-fg">       </span>__module__ <span class="ansi-blue-fg">=</span> _call_location<span class="ansi-blue-fg">(</span>outer<span class="ansi-blue-fg">=</span><span class="ansi-green-fg">True</span><span class="ansi-blue-fg">)</span>
<span class="ansi-green-intense-fg ansi-bold">    181</span> 
<span class="ansi-green-intense-fg ansi-bold">    182</span>       <span class="ansi-blue-fg">@</span>_wrap_decorator<span class="ansi-blue-fg">(</span>func_or_class<span class="ansi-blue-fg">.</span>__init__<span class="ansi-blue-fg">)</span>

<span class="ansi-green-fg">~/anaconda3/envs/tf/lib/python3.6/site-packages/tensorflow/python/util/deprecation.py</span> in <span class="ansi-cyan-fg">_call_location</span><span class="ansi-blue-fg">(outer)</span>
<span class="ansi-green-intense-fg ansi-bold">     76</span> <span class="ansi-green-fg">def</span> _call_location<span class="ansi-blue-fg">(</span>outer<span class="ansi-blue-fg">=</span><span class="ansi-green-fg">False</span><span class="ansi-blue-fg">)</span><span class="ansi-blue-fg">:</span>
<span class="ansi-green-intense-fg ansi-bold">     77</span>   <span class="ansi-blue-fg">&#34;&#34;&#34;Returns call location given level up from current call.&#34;&#34;&#34;</span>
<span class="ansi-green-fg">---&gt; 78</span><span class="ansi-red-fg">   </span>frame <span class="ansi-blue-fg">=</span> tf_inspect<span class="ansi-blue-fg">.</span>currentframe<span class="ansi-blue-fg">(</span><span class="ansi-blue-fg">)</span>
<span class="ansi-green-intense-fg ansi-bold">     79</span>   <span class="ansi-green-fg">if</span> frame<span class="ansi-blue-fg">:</span>
<span class="ansi-green-intense-fg ansi-bold">     80</span>     <span class="ansi-red-fg"># CPython internals are available, use them for performance.</span>

<span class="ansi-green-fg">~/anaconda3/envs/tf/lib/python3.6/site-packages/tensorflow/python/util/tf_inspect.py</span> in <span class="ansi-cyan-fg">currentframe</span><span class="ansi-blue-fg">()</span>
<span class="ansi-green-intense-fg ansi-bold">     40</span> <span class="ansi-green-fg">def</span> currentframe<span class="ansi-blue-fg">(</span><span class="ansi-blue-fg">)</span><span class="ansi-blue-fg">:</span>
<span class="ansi-green-intense-fg ansi-bold">     41</span>   <span class="ansi-blue-fg">&#34;&#34;&#34;TFDecorator-aware replacement for inspect.currentframe.&#34;&#34;&#34;</span>
<span class="ansi-green-fg">---&gt; 42</span><span class="ansi-red-fg">   </span><span class="ansi-green-fg">return</span> _inspect<span class="ansi-blue-fg">.</span>stack<span class="ansi-blue-fg">(</span><span class="ansi-blue-fg">)</span><span class="ansi-blue-fg">[</span><span class="ansi-cyan-fg">1</span><span class="ansi-blue-fg">]</span><span class="ansi-blue-fg">[</span><span class="ansi-cyan-fg">0</span><span class="ansi-blue-fg">]</span>
<span class="ansi-green-intense-fg ansi-bold">     43</span> 
<span class="ansi-green-intense-fg ansi-bold">     44</span> 

<span class="ansi-green-fg">~/anaconda3/envs/tf/lib/python3.6/inspect.py</span> in <span class="ansi-cyan-fg">stack</span><span class="ansi-blue-fg">(context)</span>
<span class="ansi-green-intense-fg ansi-bold">   1497</span> <span class="ansi-green-fg">def</span> stack<span class="ansi-blue-fg">(</span>context<span class="ansi-blue-fg">=</span><span class="ansi-cyan-fg">1</span><span class="ansi-blue-fg">)</span><span class="ansi-blue-fg">:</span>
<span class="ansi-green-intense-fg ansi-bold">   1498</span>     <span class="ansi-blue-fg">&#34;&#34;&#34;Return a list of records for the stack above the caller&#39;s frame.&#34;&#34;&#34;</span>
<span class="ansi-green-fg">-&gt; 1499</span><span class="ansi-red-fg">     </span><span class="ansi-green-fg">return</span> getouterframes<span class="ansi-blue-fg">(</span>sys<span class="ansi-blue-fg">.</span>_getframe<span class="ansi-blue-fg">(</span><span class="ansi-cyan-fg">1</span><span class="ansi-blue-fg">)</span><span class="ansi-blue-fg">,</span> context<span class="ansi-blue-fg">)</span>
<span class="ansi-green-intense-fg ansi-bold">   1500</span> 
<span class="ansi-green-intense-fg ansi-bold">   1501</span> <span class="ansi-green-fg">def</span> trace<span class="ansi-blue-fg">(</span>context<span class="ansi-blue-fg">=</span><span class="ansi-cyan-fg">1</span><span class="ansi-blue-fg">)</span><span class="ansi-blue-fg">:</span>

<span class="ansi-green-fg">~/anaconda3/envs/tf/lib/python3.6/inspect.py</span> in <span class="ansi-cyan-fg">getouterframes</span><span class="ansi-blue-fg">(frame, context)</span>
<span class="ansi-green-intense-fg ansi-bold">   1474</span>     framelist <span class="ansi-blue-fg">=</span> <span class="ansi-blue-fg">[</span><span class="ansi-blue-fg">]</span>
<span class="ansi-green-intense-fg ansi-bold">   1475</span>     <span class="ansi-green-fg">while</span> frame<span class="ansi-blue-fg">:</span>
<span class="ansi-green-fg">-&gt; 1476</span><span class="ansi-red-fg">         </span>frameinfo <span class="ansi-blue-fg">=</span> <span class="ansi-blue-fg">(</span>frame<span class="ansi-blue-fg">,</span><span class="ansi-blue-fg">)</span> <span class="ansi-blue-fg">+</span> getframeinfo<span class="ansi-blue-fg">(</span>frame<span class="ansi-blue-fg">,</span> context<span class="ansi-blue-fg">)</span>
<span class="ansi-green-intense-fg ansi-bold">   1477</span>         framelist<span class="ansi-blue-fg">.</span>append<span class="ansi-blue-fg">(</span>FrameInfo<span class="ansi-blue-fg">(</span><span class="ansi-blue-fg">*</span>frameinfo<span class="ansi-blue-fg">)</span><span class="ansi-blue-fg">)</span>
<span class="ansi-green-intense-fg ansi-bold">   1478</span>         frame <span class="ansi-blue-fg">=</span> frame<span class="ansi-blue-fg">.</span>f_back

<span class="ansi-green-fg">~/anaconda3/envs/tf/lib/python3.6/inspect.py</span> in <span class="ansi-cyan-fg">getframeinfo</span><span class="ansi-blue-fg">(frame, context)</span>
<span class="ansi-green-intense-fg ansi-bold">   1448</span>         start <span class="ansi-blue-fg">=</span> lineno <span class="ansi-blue-fg">-</span> <span class="ansi-cyan-fg">1</span> <span class="ansi-blue-fg">-</span> context<span class="ansi-blue-fg">//</span><span class="ansi-cyan-fg">2</span>
<span class="ansi-green-intense-fg ansi-bold">   1449</span>         <span class="ansi-green-fg">try</span><span class="ansi-blue-fg">:</span>
<span class="ansi-green-fg">-&gt; 1450</span><span class="ansi-red-fg">             </span>lines<span class="ansi-blue-fg">,</span> lnum <span class="ansi-blue-fg">=</span> findsource<span class="ansi-blue-fg">(</span>frame<span class="ansi-blue-fg">)</span>
<span class="ansi-green-intense-fg ansi-bold">   1451</span>         <span class="ansi-green-fg">except</span> OSError<span class="ansi-blue-fg">:</span>
<span class="ansi-green-intense-fg ansi-bold">   1452</span>             lines <span class="ansi-blue-fg">=</span> index <span class="ansi-blue-fg">=</span> <span class="ansi-green-fg">None</span>

<span class="ansi-green-fg">~/anaconda3/envs/tf/lib/python3.6/inspect.py</span> in <span class="ansi-cyan-fg">findsource</span><span class="ansi-blue-fg">(object)</span>
<span class="ansi-green-intense-fg ansi-bold">    778</span>             <span class="ansi-green-fg">raise</span> OSError<span class="ansi-blue-fg">(</span><span class="ansi-blue-fg">&#39;source code not available&#39;</span><span class="ansi-blue-fg">)</span>
<span class="ansi-green-intense-fg ansi-bold">    779</span> 
<span class="ansi-green-fg">--&gt; 780</span><span class="ansi-red-fg">     </span>module <span class="ansi-blue-fg">=</span> getmodule<span class="ansi-blue-fg">(</span>object<span class="ansi-blue-fg">,</span> file<span class="ansi-blue-fg">)</span>
<span class="ansi-green-intense-fg ansi-bold">    781</span>     <span class="ansi-green-fg">if</span> module<span class="ansi-blue-fg">:</span>
<span class="ansi-green-intense-fg ansi-bold">    782</span>         lines <span class="ansi-blue-fg">=</span> linecache<span class="ansi-blue-fg">.</span>getlines<span class="ansi-blue-fg">(</span>file<span class="ansi-blue-fg">,</span> module<span class="ansi-blue-fg">.</span>__dict__<span class="ansi-blue-fg">)</span>

<span class="ansi-green-fg">~/anaconda3/envs/tf/lib/python3.6/inspect.py</span> in <span class="ansi-cyan-fg">getmodule</span><span class="ansi-blue-fg">(object, _filename)</span>
<span class="ansi-green-intense-fg ansi-bold">    731</span>     <span class="ansi-red-fg"># Copy sys.modules in order to cope with changes while iterating</span>
<span class="ansi-green-intense-fg ansi-bold">    732</span>     <span class="ansi-green-fg">for</span> modname<span class="ansi-blue-fg">,</span> module <span class="ansi-green-fg">in</span> list<span class="ansi-blue-fg">(</span>sys<span class="ansi-blue-fg">.</span>modules<span class="ansi-blue-fg">.</span>items<span class="ansi-blue-fg">(</span><span class="ansi-blue-fg">)</span><span class="ansi-blue-fg">)</span><span class="ansi-blue-fg">:</span>
<span class="ansi-green-fg">--&gt; 733</span><span class="ansi-red-fg">         </span><span class="ansi-green-fg">if</span> ismodule<span class="ansi-blue-fg">(</span>module<span class="ansi-blue-fg">)</span> <span class="ansi-green-fg">and</span> hasattr<span class="ansi-blue-fg">(</span>module<span class="ansi-blue-fg">,</span> <span class="ansi-blue-fg">&#39;__file__&#39;</span><span class="ansi-blue-fg">)</span><span class="ansi-blue-fg">:</span>
<span class="ansi-green-intense-fg ansi-bold">    734</span>             f <span class="ansi-blue-fg">=</span> module<span class="ansi-blue-fg">.</span>__file__
<span class="ansi-green-intense-fg ansi-bold">    735</span>             <span class="ansi-green-fg">if</span> f <span class="ansi-blue-fg">==</span> _filesbymodname<span class="ansi-blue-fg">.</span>get<span class="ansi-blue-fg">(</span>modname<span class="ansi-blue-fg">,</span> <span class="ansi-green-fg">None</span><span class="ansi-blue-fg">)</span><span class="ansi-blue-fg">:</span>

<span class="ansi-red-fg">KeyboardInterrupt</span>: </pre>
</div>
</div>

</div>
</div>

</div>
<div class="cell border-box-sizing text_cell rendered"><div class="prompt input_prompt">
</div>
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<h1 id="Spatial-Transformer-Networks">Spatial Transformer Networks<a class="anchor-link" href="#Spatial-Transformer-Networks">&#182;</a></h1><p><a href="https://arxiv.org/pdf/1506.02025.pdf">Spatial Transformer Networks, by Jaderberg, M. et. al</a> explores a novel convolutional neural network (CNN) module designed by the authors at Google Deepmind.
Spatial Transformers, aptly named, allow a network to incorporate spatial transformations, typically on the input image, which can have the effect of cropping, reorienting, or undistorting the image in question.
The authors show how spatial transformations can take the place of attention networks, and additionally solve previous problems with translational invariance in CNNs.
They can be added seamlessly to any neural network.
They are differentiable, and therefore can be trained through simple backpropogation.</p>
<p>First, let's consider the motivations behind spatial transformer networks, starting with attention mechanisms in neural architecture.</p>
<h3 id="Attention">Attention<a class="anchor-link" href="#Attention">&#182;</a></h3><p>Attention mechanisms in neural networks give them the ability to focus on subsets of features. In image processing, this takes the shape of spatial localization of the features. In the paper Show,</p>
<p><img src="img/show-attend-tell.png" alt="Image"></p>
<p><a href="https://arxiv.org/abs/1502.03044">image from Show, Attend, and Tell</a></p>
<p>Why is this so effective?  Here's the intuition I could come up with: Part of it is the problem space of most testing with CNNs: Single object classification or some single object-based task. Even extending this to several objects, there is often a large amount of irrelevant background information in the images. As such, this is an effective dimensionality reduction technique.</p>
<p>To contrast, it may not be effective for segmentation of a large number of objects, or for semantic segmentation tasks, or for something with extracting texture features.
In other words, tasks where you might expect important features to be comprehensively spread through the image.</p>
<p>In CNNs, we can consider attention in other image processing terms, taking the form of a binary or probability mask over an image (or layer), thereby focusing the effective activations within a small region.
This naive method of attention works, but with a heavy computational load. Kernels must still be computed over the whole image.</p>
<p>Another proposed option, is to crop the image.
However, this method also faces problems, as it so far has been non-differentiable, so some sort of stochastic or baked-in cropping method must be implemented.</p>
<p>As we'll see, image cropping can actually be modeled by a constrained linear transformation.</p>
<h3 id="Translational-Invariance">Translational Invariance<a class="anchor-link" href="#Translational-Invariance">&#182;</a></h3><p>$\forall \delta \ A f = A T_\delta f$</p>
<p><strong>Translational invariance</strong> is the property that transforming a feature map does not affect the resulting output. Convolutional Neural networks do not have this feature, instead, because of parameter sharing, they have the property that they are <strong>translationally equivariant</strong>:</p>
<p>$\forall \delta \  T_\delta A f = A T_\delta f$</p>
<p>this <em>would</em> be totally sufficient, except that eventually, we are going to feed the network into a dense layer.  Dense layers by definition have no spatial relationships built in, so we need the CNN to be able to feed some proper positional information to the dense layer.</p>
<p>In a sense, max pooling layers create some "translational invariance" by only accepting one input of a local region.  Of course, this is only a very slight translation for each layer, so it's not nearly the property we're looking for.</p>
<p>Next, let's quickly go over basic spatial transforms.</p>
<p>The two main concepts involved here are spatial transformations, and sampling:</p>
<h3 id="Spatial-Transformations">Spatial Transformations<a class="anchor-link" href="#Spatial-Transformations">&#182;</a></h3><p>For a much deeper look at these spatial transformations, <a href="https://people.cs.clemson.edu/~dhouse/courses/401/notes/affines-matrices.pdf">check out this resource</a></p>
<p>A "spatial transformation" is a transformation on the <em>coordinate system</em> of an image.</p>
<p>Let a pixel $P$ be defined at indices: $(n, m) \in \mathbb{N}$</p>
<p>then the transformation $T_\theta$ maps the pixel $P$ to a new point $(x', y') \in \mathbb{R}^2$</p>
<p>The most basic forms of spatial transformations are linear or projective transformations, which can be represented with matrix multiplication.
Let's look at some examples of these matrices, to have a look at what the <em>parameters</em> of such transformations are.</p>
<h5 id="linear">linear<a class="anchor-link" href="#linear">&#182;</a></h5><p>Suppose we consider each pair of integer indices in the image, $U$, to be a set of spatial coordinates. Let's denote the indices as $n$, and $m$.  The spatial transformation will map each pair of indices $(n, m)$ to a pair $(x', y')$.</p>
<p>For linear transformations, we can easily represent this transformation as a matrix. Then, depending on <em>how</em> we want to transform the matrix, we can</p>
<p>for a "rigid body" transformation, we have 3 parameters, $t_x, t_y, \theta$:</p>
<p>$$\begin{aligned}
\begin{bmatrix} x' \\ y' \\ 1 \end{bmatrix} &amp;= \begin{bmatrix} \cos(\theta) &amp; -\sin(\theta) &amp; -t_x \\ \sin(\theta) &amp; \cos(\theta) &amp; -t_y \\ 0 &amp; 0 &amp; 1 \end{bmatrix} \begin{bmatrix} n \\ m \\ 1 \end{bmatrix}
\end{aligned}
$$</p>
<p>a "similarity" transformation, with 4 parameters $s, t_x, t_y, \theta$:</p>
<p>$$\begin{aligned}
\begin{bmatrix} x' \\ y' \\ 1 \end{bmatrix} &amp;= \begin{bmatrix} s \cos(\theta) &amp;  -s \sin(\theta) &amp; -t_x \\ s \sin(\theta) &amp; s \cos(\theta) &amp; -t_y \\ 0 &amp; 0 &amp; 1 \end{bmatrix} \begin{bmatrix} n \\ m \\ 1 \end{bmatrix}
\end{aligned}
$$</p>
<p>for more general, "affine" transformations, 6 parameters $a, b, c, d, t_x, t_y, \theta$:</p>
<p>$$\begin{aligned}
\begin{bmatrix} x' \\ y' \\ 1 \end{bmatrix} &amp;= \begin{bmatrix} a &amp; b &amp; t_x \\ c &amp; d &amp; t_y \\ 0 &amp; 0 &amp; 1 \end{bmatrix} \begin{bmatrix} n \\ m \\ 1 \end{bmatrix}
\end{aligned}
$$</p>
<h5 id="nonlinear">nonlinear<a class="anchor-link" href="#nonlinear">&#182;</a></h5><p>finally, "homographic" or "projective" transformations (our first nonlinear transform), with 8 parameters:</p>
<p>$$\begin{aligned}
\begin{bmatrix} x' \\ y' \\ 1 \end{bmatrix} &amp;= \begin{bmatrix} a &amp; b &amp; t_x \\ c &amp; d &amp; t_y \\ e &amp; f &amp; t_z \end{bmatrix} \begin{bmatrix} n \\ m \\ 1 \end{bmatrix}
\end{aligned}
$$</p>
<p>These parameters are also called the "degrees of freedom" of the transform, where the degrees of freedom are the minimum number of parameters required to fully specify that type of transformation.
In the projective transform, although the number of variables shown is 9, the last row has the constraint of always summing to 1, hence you can remove one parameter.</p>
<h3 id="sampling">sampling<a class="anchor-link" href="#sampling">&#182;</a></h3><p>the caveat with these transforms, is that $(x', y')$ are typically not integers, which conflicts with the <em>digital</em> representation of images.
We will need to now find the values of the transformed image at new integer points $(n', m') \in \mathbb{N}$</p>
<p>To handle this, we'll need sampling theory.</p>
<p><strong>Interactive Notebook Kernel</strong>: if this notebook is being run on a kernel, we can explore affine transforms and sampling with the interactive widget below. We shall also discuss sampling more later on.</p>

</div>
</div>
</div>
<div class="cell border-box-sizing code_cell rendered">
<div class="input">
<div class="prompt input_prompt">In&nbsp;[&nbsp;]:</div>
<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">N</span> <span class="o">=</span> <span class="mi">128</span>
<span class="n">square2</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="n">N</span><span class="p">,</span> <span class="n">N</span><span class="p">))</span>
<span class="n">square2</span><span class="p">[</span><span class="mi">60</span><span class="p">:</span><span class="mi">100</span><span class="p">,</span> <span class="mi">60</span><span class="p">:</span><span class="mi">100</span><span class="p">]</span> <span class="o">=</span> <span class="mi">1</span>
<span class="n">horse</span> <span class="o">=</span> <span class="n">rescale</span><span class="p">(</span><span class="n">skimage</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">horse</span><span class="p">(),</span> <span class="o">.</span><span class="mi">5</span><span class="p">,</span> <span class="n">anti_aliasing</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">multichannel</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">mode</span><span class="o">=</span><span class="s1">&#39;constant&#39;</span><span class="p">)</span>
<span class="n">coffee</span> <span class="o">=</span> <span class="n">rescale</span><span class="p">(</span><span class="n">skimage</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">coffee</span><span class="p">(),</span> <span class="mf">1.0</span><span class="p">,</span> <span class="n">anti_aliasing</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">multichannel</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">mode</span><span class="o">=</span><span class="s1">&#39;constant&#39;</span><span class="p">)</span>
<span class="n">interp_dict</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span>
    <span class="p">[(</span><span class="n">y</span><span class="p">,</span> <span class="n">x</span><span class="p">)</span> <span class="k">for</span> <span class="n">x</span><span class="p">,</span> <span class="n">y</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">([</span><span class="s1">&#39;Nearest Neighbor&#39;</span><span class="p">,</span> <span class="s1">&#39;Linear&#39;</span><span class="p">,</span> <span class="s1">&#39;Quadratic&#39;</span><span class="p">,</span> <span class="s1">&#39;Cubic&#39;</span><span class="p">])]</span>
<span class="p">)</span>
<span class="k">def</span> <span class="nf">f</span><span class="p">(</span><span class="n">tx</span><span class="p">,</span> <span class="n">ty</span><span class="p">,</span> <span class="n">θ</span><span class="p">,</span> <span class="n">s</span><span class="p">,</span> <span class="n">kx</span><span class="p">,</span> <span class="n">ky</span><span class="p">,</span> <span class="n">interp</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">image</span><span class="o">=</span><span class="s1">&#39;square&#39;</span><span class="p">):</span>
    <span class="n">fig</span><span class="o">=</span><span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">8</span><span class="p">,</span> <span class="mi">8</span><span class="p">),</span> <span class="n">dpi</span><span class="o">=</span> <span class="mi">80</span><span class="p">,</span> <span class="n">facecolor</span><span class="o">=</span><span class="s1">&#39;w&#39;</span><span class="p">,</span> <span class="n">edgecolor</span><span class="o">=</span><span class="s1">&#39;k&#39;</span><span class="p">)</span>
    <span class="n">interp</span> <span class="o">=</span> <span class="n">interp_dict</span><span class="p">[</span><span class="n">interp</span><span class="p">]</span>  <span class="c1"># skimage uses integer codes for interpolation.</span>
    <span class="k">if</span> <span class="n">interp</span> <span class="o">==</span> <span class="mi">2</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;ERROR: can&#39;t use thin plate spline interpolation due to a bug in scipy&quot;</span><span class="p">)</span>
        <span class="n">interp</span> <span class="o">=</span> <span class="mi">1</span>
    <span class="n">θ</span> <span class="o">=</span>  <span class="n">θ</span> <span class="o">/</span> <span class="mi">180</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">pi</span>
    <span class="n">mat</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span>
        <span class="p">[</span><span class="n">s</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">cos</span><span class="p">(</span><span class="n">θ</span><span class="p">),</span>  <span class="o">-</span><span class="n">s</span> <span class="o">*</span> <span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">sin</span><span class="p">(</span><span class="n">θ</span><span class="p">)</span> <span class="o">+</span> <span class="n">kx</span><span class="p">),</span> <span class="n">tx</span><span class="p">],</span>
        <span class="p">[</span><span class="n">s</span> <span class="o">*</span> <span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">sin</span><span class="p">(</span><span class="n">θ</span><span class="p">)</span> <span class="o">+</span> <span class="n">ky</span><span class="p">),</span> <span class="n">s</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">cos</span><span class="p">(</span><span class="n">θ</span><span class="p">),</span> <span class="n">ty</span><span class="p">],</span>
        <span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">]</span>
    <span class="p">])</span>
    <span class="k">if</span> <span class="n">image</span> <span class="o">==</span> <span class="s1">&#39;square&#39;</span><span class="p">:</span>
        <span class="n">image</span> <span class="o">=</span> <span class="n">square2</span>
        <span class="n">cmap</span> <span class="o">=</span> <span class="s1">&#39;gray&#39;</span>
    <span class="k">elif</span> <span class="n">image</span> <span class="o">==</span> <span class="s1">&#39;horse&#39;</span><span class="p">:</span>
        <span class="n">image</span> <span class="o">=</span> <span class="n">horse</span>
        <span class="n">dims</span> <span class="o">=</span> <span class="n">image</span><span class="o">.</span><span class="n">shape</span>
        <span class="n">cmap</span> <span class="o">=</span> <span class="s1">&#39;gray&#39;</span>
    <span class="k">elif</span> <span class="n">image</span> <span class="o">==</span> <span class="s1">&#39;coffee&#39;</span><span class="p">:</span>
        <span class="n">image</span> <span class="o">=</span> <span class="n">coffee</span>
        <span class="n">cmap</span> <span class="o">=</span> <span class="s1">&#39;RGB&#39;</span>
    <span class="n">xdim</span> <span class="o">=</span> <span class="n">image</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
    <span class="n">ydim</span> <span class="o">=</span> <span class="n">image</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
    <span class="n">shiftR</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span>
            <span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="o">-</span><span class="n">xdim</span><span class="p">],</span>
            <span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="o">-</span><span class="n">ydim</span><span class="p">],</span>
            <span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">]</span> <span class="c1"># rigid body</span>
        <span class="p">])</span>
    <span class="n">shiftL</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span>
            <span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">xdim</span><span class="o">/</span><span class="mi">2</span><span class="p">],</span>
            <span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">ydim</span><span class="o">/</span><span class="mi">2</span><span class="p">],</span>
            <span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">]</span> <span class="c1"># rigid body</span>
        <span class="p">])</span>
    <span class="n">mat</span> <span class="o">=</span> <span class="n">shiftL</span> <span class="o">@</span> <span class="n">mat</span> <span class="o">@</span> <span class="n">shiftR</span>
    
    <span class="n">img</span> <span class="o">=</span> <span class="n">warp</span><span class="p">(</span><span class="n">image</span><span class="p">,</span> <span class="n">mat</span><span class="p">,</span> <span class="n">output_shape</span><span class="o">=</span><span class="p">([</span><span class="mi">2</span><span class="o">*</span><span class="n">x</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">image</span><span class="o">.</span><span class="n">shape</span><span class="p">]),</span> 
               <span class="n">order</span><span class="o">=</span><span class="n">interp</span><span class="p">,</span> <span class="n">mode</span><span class="o">=</span><span class="s1">&#39;constant&#39;</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">cmap</span> <span class="o">!=</span> <span class="s1">&#39;RGB&#39;</span><span class="p">:</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">imshow</span><span class="p">(</span><span class="n">img</span><span class="p">,</span> <span class="n">cmap</span><span class="o">=</span><span class="n">cmap</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">imshow</span><span class="p">(</span><span class="n">img</span><span class="p">)</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">grid</span><span class="p">()</span>

<span class="k">def</span> <span class="nf">reset_values</span><span class="p">(</span><span class="n">b</span><span class="p">):</span>
    <span class="k">for</span> <span class="n">child</span> <span class="ow">in</span> <span class="n">plot2</span><span class="o">.</span><span class="n">children</span><span class="p">:</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">child</span><span class="p">,</span> <span class="s1">&#39;description&#39;</span><span class="p">):</span>
            <span class="k">continue</span>
        <span class="k">elif</span> <span class="n">child</span><span class="o">.</span><span class="n">description</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;tx&#39;</span><span class="p">,</span> <span class="s1">&#39;ty&#39;</span><span class="p">,</span> <span class="s1">&#39;θ&#39;</span><span class="p">,</span> <span class="s1">&#39;kx&#39;</span><span class="p">,</span> <span class="s1">&#39;ky&#39;</span><span class="p">]:</span>
            <span class="n">child</span><span class="o">.</span><span class="n">value</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="k">elif</span> <span class="n">child</span><span class="o">.</span><span class="n">description</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;s&#39;</span><span class="p">]:</span>
            <span class="n">child</span><span class="o">.</span><span class="n">value</span> <span class="o">=</span> <span class="mf">1.0</span>

<span class="n">reset_button</span> <span class="o">=</span> <span class="n">widgets</span><span class="o">.</span><span class="n">Button</span><span class="p">(</span><span class="n">description</span> <span class="o">=</span> <span class="s2">&quot;Reset&quot;</span><span class="p">)</span>
<span class="n">reset_button</span><span class="o">.</span><span class="n">on_click</span><span class="p">(</span><span class="n">reset_values</span><span class="p">)</span>

<span class="n">x2</span> <span class="o">=</span> <span class="n">widgets</span><span class="o">.</span><span class="n">IntSlider</span><span class="p">(</span><span class="nb">min</span><span class="o">=-</span><span class="mi">200</span><span class="p">,</span> <span class="nb">max</span><span class="o">=</span><span class="mi">200</span><span class="p">,</span> <span class="n">step</span><span class="o">=</span><span class="mf">9.8</span><span class="p">,</span> <span class="n">orientation</span><span class="o">=</span><span class="s1">&#39;vertical&#39;</span><span class="p">,</span> <span class="n">description</span><span class="o">=</span><span class="s1">&#39;$t_x$&#39;</span><span class="p">)</span>
<span class="n">y2</span> <span class="o">=</span> <span class="n">widgets</span><span class="o">.</span><span class="n">IntSlider</span><span class="p">(</span><span class="nb">min</span><span class="o">=-</span><span class="mi">200</span><span class="p">,</span> <span class="nb">max</span><span class="o">=</span><span class="mi">200</span><span class="p">,</span> <span class="n">step</span><span class="o">=</span><span class="mf">9.8</span><span class="p">,</span> <span class="n">orientation</span><span class="o">=</span><span class="s1">&#39;vertical&#39;</span><span class="p">,</span> <span class="n">description</span><span class="o">=</span><span class="s1">&#39;$t_y$&#39;</span><span class="p">)</span>
<span class="n">t2</span> <span class="o">=</span> <span class="n">widgets</span><span class="o">.</span><span class="n">IntSlider</span><span class="p">(</span><span class="nb">min</span><span class="o">=-</span><span class="mi">180</span><span class="p">,</span> <span class="nb">max</span><span class="o">=</span><span class="mi">180</span><span class="p">,</span> <span class="n">step</span><span class="o">=</span><span class="mi">18</span><span class="p">,</span> <span class="n">orientation</span><span class="o">=</span><span class="s1">&#39;vertical&#39;</span><span class="p">,</span> <span class="n">description</span><span class="o">=</span><span class="sa">r</span><span class="s1">&#39;$\theta$&#39;</span><span class="p">)</span>
<span class="n">kx</span> <span class="o">=</span> <span class="n">widgets</span><span class="o">.</span><span class="n">FloatSlider</span><span class="p">(</span><span class="nb">min</span><span class="o">=-</span><span class="mf">2.0</span><span class="p">,</span> <span class="nb">max</span><span class="o">=</span><span class="mf">2.0</span><span class="p">,</span> <span class="n">value</span><span class="o">=</span><span class="mf">0.0</span><span class="p">,</span> <span class="n">orientation</span><span class="o">=</span><span class="s1">&#39;vertical&#39;</span><span class="p">,</span> <span class="n">description</span><span class="o">=</span><span class="s1">&#39;$k_x$&#39;</span><span class="p">)</span>
<span class="n">ky</span> <span class="o">=</span> <span class="n">widgets</span><span class="o">.</span><span class="n">FloatSlider</span><span class="p">(</span><span class="nb">min</span><span class="o">=-</span><span class="mf">2.0</span><span class="p">,</span> <span class="nb">max</span><span class="o">=</span><span class="mf">2.0</span><span class="p">,</span> <span class="n">value</span><span class="o">=</span><span class="mf">0.0</span><span class="p">,</span> <span class="n">orientation</span><span class="o">=</span><span class="s1">&#39;vertical&#39;</span><span class="p">,</span> <span class="n">description</span><span class="o">=</span><span class="s1">&#39;$k_y$&#39;</span><span class="p">)</span>
<span class="n">s</span> <span class="o">=</span> <span class="n">widgets</span><span class="o">.</span><span class="n">FloatSlider</span><span class="p">(</span><span class="nb">min</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="nb">max</span><span class="o">=</span><span class="mf">2.0</span><span class="p">,</span> <span class="n">value</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">orientation</span><span class="o">=</span><span class="s1">&#39;vertical&#39;</span><span class="p">,</span> <span class="n">description</span><span class="o">=</span><span class="s1">&#39;$s$&#39;</span><span class="p">)</span>
<span class="n">interpolation</span> <span class="o">=</span> <span class="n">widgets</span><span class="o">.</span><span class="n">RadioButtons</span><span class="p">(</span>
    <span class="n">options</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;Nearest Neighbor&#39;</span><span class="p">,</span> <span class="s1">&#39;Linear&#39;</span><span class="p">,</span> <span class="s1">&#39;Quadratic&#39;</span><span class="p">,</span> <span class="s1">&#39;Cubic&#39;</span><span class="p">][::</span><span class="o">-</span><span class="mi">1</span><span class="p">],</span> <span class="n">value</span><span class="o">=</span><span class="s1">&#39;Linear&#39;</span><span class="p">,</span> <span class="n">description</span><span class="o">=</span><span class="s1">&#39;interpolation&#39;</span><span class="p">)</span>
<span class="n">images</span> <span class="o">=</span> <span class="n">widgets</span><span class="o">.</span><span class="n">RadioButtons</span><span class="p">(</span><span class="n">options</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;square&#39;</span><span class="p">,</span> <span class="s1">&#39;horse&#39;</span><span class="p">,</span> <span class="s1">&#39;coffee&#39;</span><span class="p">])</span>
<span class="n">plot2</span> <span class="o">=</span> <span class="n">interactive</span><span class="p">(</span><span class="n">f</span><span class="p">,</span> <span class="n">tx</span><span class="o">=</span><span class="n">x2</span><span class="p">,</span> <span class="n">ty</span><span class="o">=</span><span class="n">y2</span><span class="p">,</span> <span class="n">θ</span><span class="o">=</span><span class="n">t2</span><span class="p">,</span> <span class="n">s</span><span class="o">=</span><span class="n">s</span><span class="p">,</span> <span class="n">kx</span><span class="o">=</span><span class="n">kx</span><span class="p">,</span> <span class="n">ky</span><span class="o">=</span><span class="n">ky</span><span class="p">,</span><span class="n">interp</span><span class="o">=</span><span class="n">interpolation</span><span class="p">,</span> <span class="n">image</span><span class="o">=</span><span class="n">images</span><span class="p">)</span>
<span class="n">layout</span> <span class="o">=</span> <span class="n">Layout</span><span class="p">(</span><span class="n">display</span><span class="o">=</span><span class="s1">&#39;flex&#39;</span><span class="p">,</span> <span class="n">flex_flow</span><span class="o">=</span><span class="s1">&#39;row&#39;</span><span class="p">,</span> <span class="n">justify_content</span><span class="o">=</span><span class="s1">&#39;space-between&#39;</span><span class="p">)</span>
</pre></div>

</div>
</div>
</div>

</div>
<div class="cell border-box-sizing code_cell rendered">
<div class="input">
<div class="prompt input_prompt">In&nbsp;[&nbsp;]:</div>
<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">plot2</span><span class="o">.</span><span class="n">update</span><span class="p">()</span>
<span class="n">display</span><span class="p">(</span><span class="n">HBox</span><span class="p">([</span><span class="n">plot2</span><span class="o">.</span><span class="n">children</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">],</span> <span class="n">images</span><span class="p">]))</span>
<span class="n">display</span><span class="p">(</span><span class="n">HBox</span><span class="p">([</span><span class="o">*</span><span class="n">plot2</span><span class="o">.</span><span class="n">children</span><span class="p">[:</span><span class="o">-</span><span class="mi">2</span><span class="p">],</span> <span class="n">reset_button</span><span class="p">],</span> <span class="n">layout</span><span class="o">=</span><span class="n">layout</span><span class="p">))</span>
</pre></div>

</div>
</div>
</div>

</div>
<div class="cell border-box-sizing text_cell rendered"><div class="prompt input_prompt">
</div>
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<p>The widget above shows for a particular parameterization (defined on the sliders) of the affine transformation, what the end effect will be on the image.
You can choose between the square, an outline of a horse, and a photograph of a coffee cup.
I encourage you to test out both the available parameters.
You can also toggle different interpolation methods, to see how choice of sampling affects the output image (quadratic does not work due to a bug in the current version of scikit-image).</p>
<h3 id="The-Spatial-Transformer-Module:-3-pieces">The Spatial Transformer Module: 3 pieces<a class="anchor-link" href="#The-Spatial-Transformer-Module:-3-pieces">&#182;</a></h3><p>The Spatial Transformer consists of three pieces, a "localization network", a "grid generator", and a sampler*.</p>
<p><img src="img/STN_figure_2.png" alt="network configuration"></p>
<h5 id="the-localization-network">the localization network<a class="anchor-link" href="#the-localization-network">&#182;</a></h5><p>The localization network is how the spatial transformation is decided for each input in the forward pass. 
It's simple in concept, it is a standard CNN, where the output units are the free parameters in the transformation model we choose (e.g. affine, similarity, projective, etc.).
For example, if we wanted an affine transformation, the localization network should have 6 output units.  For a similarity transform, 4 output units, etc.
The rest is taken care of by backpropogation!
The weight initialization should be small, making the model very close to an identity transform at first.</p>
<h5 id="the-grid-generator">the grid generator<a class="anchor-link" href="#the-grid-generator">&#182;</a></h5><p>The transformation T is generated from the above network's parameters. Then we need to compute <em>which</em> points on the image we are sampling from after the transformation is applied, then place them into an output layer. The output layer may need not strictly be the same size as the input. In fact, the size of the output layer can be freely chosen.</p>
<p><img src="img/STN_figure_3.png" alt="grid generator"></p>
<p>In the image above we can see the identity transformation contrasted with an affine transformation. The sampling grid generates the points which must be sampled onto. This is illustrated in the example above, where we see the quadrilateral of points on $U$ going directly into the next layer $V$. However, just like in the initial discussion of transformations, the points on the quadrilateral will not, in general, correspond directly to pixel coordinates in $U$. This is why we will need to <em>resample</em> the points.</p>
<h5 id="sampling">sampling<a class="anchor-link" href="#sampling">&#182;</a></h5><p>The remaining issue is to recompute the value of the points we sample from on the image.  Because they are in between pixel coordinates, they require sampling. <em>In this context, sampling has nothing to do with statistical sampling, it is interpolation.</em> The widget above does a good job of giving a visual inspection of sampling, let's look at how this occurs in the backpropogation.</p>
<h3 id="backpropagation">backpropagation<a class="anchor-link" href="#backpropagation">&#182;</a></h3><p>Take equation <strong>(3)</strong> from the paper, which gives the tranformed image $V$ from the input image $U$.</p>
<p>$$
V_i^c = \sum_n^H \sum_m^W U_{nm}^c k(x_i^s - m; \Phi_x) k(y_i^s - n; \Phi_y) \forall i \in [1...H'W'] \forall c \in [1...C]
$$</p>
<p>$k$: the sampling kernel<br>
$\Phi$: sampling kernel parameters<br>
$H, W, C$: heighth, width, channels of U<br>
$H', W'$: heighth, width of V<br>
$n, m$: indices over heighth and width (pixel coordinates) of U<br>
$i$: flat index over all points in the transformed image, V<br>
$x_i^s, y_i^s$: transformed $x$, $y$ coordinates from $T_\theta(G)$<br>
$c$: index over channels, if relevant</p>
<p>This can seem a little obtuse at first:</p>
<p>the key things to note are:</p>
<ul>
<li><p>in practice, the sampling kernel $k_\Phi$ typically behaves as a delta function, eliminating the contribution of <em>most points</em> in the image. So this is not actually a massive sum over the image, typically only 1, 4, or 16 coordinates for nearest neighbor, bilinear, and bicubic interpolation respectively.</p>
</li>
<li><p>$x_i^s$, $y_i^s$, correspond to $m$, $n$, except $x_i^s$, $y_i^s$ are continous values where $m$, $n$ are integers.  That is the problem which sampling <em>addresses</em>, to generate values for $V$ in the integer domain.</p>
</li>
<li><p>channels of the image are all transformed equivalently, so they shouldn't be given too much thought in the process.</p>
</li>
</ul>
<p>Let's look at the bilinear interpolation example, equation <strong>(5)</strong>, to review backpropogation:</p>
<p>$$
V_i^c = \sum_n^H \sum_m^W U_{nm}^c \max(0, 1 - |x_i^s - m|) \max(0, 1 - |y_i^s - n|)
$$</p>
<p>Now, taking the gradient of this function with respect to the input layer $U$:</p>
<p>$$
\frac{\partial V_i^c}{\partial U_{mn}^c} = \sum_n^H \sum_m^W \max(0, 1 - |x_i^s - m|) \max(0, 1 - |y_i^s - n|)
$$</p>
<p>Then, taking the gradient with respect to $x_i^s$,</p>
<p>$$\begin{aligned}
\frac{\partial V_i^c}{\partial x_i^s} &amp;= \frac{\partial}{\partial x_i^s} \sum_n^H \sum_m^W U_{nm}^c \max(0, 1 - |x_i^s - m|) \max(0, 1 - |y_i^s - n|) \\
&amp;= \begin{cases} \sum_n^H \sum_m^W U_{nm}^c  \max(0, 1 - |y_i^s - n|) &amp; m - 1 &lt; x_i^s &lt; m \\
-\sum_n^H \sum_m^W U_{nm}^c  \max(0, 1 - |y_i^s - n|) &amp; m &lt; x_i^s &lt; m + 1 \\
0 &amp; \text{else}
\end{cases}
\end{aligned}$$</p>
<p>We can see here that the kernel heavily constrains the number of points involved in each gradient, so only local affects should play a large role. When $\frac{\partial x}{\partial \theta}$ is considered, it completes the picture for how spatial transformations relate to gradient flow.</p>
<h2 id="By-Example">By Example<a class="anchor-link" href="#By-Example">&#182;</a></h2><p>Now let's see some Spatial Transformer Networks in action!</p>
<p>We'll start with MNIST, certainly not for showing the effectiveness, but just as a simple proof of concept.</p>

</div>
</div>
</div>
<div class="cell border-box-sizing code_cell rendered">
<div class="input">
<div class="prompt input_prompt">In&nbsp;[&nbsp;]:</div>
<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="p">(</span><span class="n">X_train</span><span class="p">,</span> <span class="n">y_train</span><span class="p">),</span> <span class="p">(</span><span class="n">X_test</span><span class="p">,</span> <span class="n">y_test</span><span class="p">)</span> <span class="o">=</span> <span class="n">keras</span><span class="o">.</span><span class="n">datasets</span><span class="o">.</span><span class="n">mnist</span><span class="o">.</span><span class="n">load_data</span><span class="p">()</span>
<span class="n">X_train</span> <span class="o">=</span> <span class="n">X_train</span><span class="p">[</span><span class="o">...</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">newaxis</span><span class="p">]</span>
<span class="n">X_test</span> <span class="o">=</span> <span class="n">X_test</span><span class="p">[</span><span class="o">...</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">newaxis</span><span class="p">]</span>
<span class="n">onehot_encoder</span> <span class="o">=</span> <span class="n">OneHotEncoder</span><span class="p">(</span><span class="n">sparse</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">categories</span><span class="o">=</span><span class="s1">&#39;auto&#39;</span><span class="p">)</span>
<span class="n">y_train</span> <span class="o">=</span> <span class="n">onehot_encoder</span><span class="o">.</span><span class="n">fit_transform</span><span class="p">(</span><span class="n">y_train</span><span class="p">[</span><span class="o">...</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">newaxis</span><span class="p">])</span>
<span class="n">y_test</span> <span class="o">=</span> <span class="n">onehot_encoder</span><span class="o">.</span><span class="n">fit_transform</span><span class="p">(</span><span class="n">y_test</span><span class="p">[</span><span class="o">...</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">newaxis</span><span class="p">])</span>
</pre></div>

</div>
</div>
</div>

</div>
<div class="cell border-box-sizing code_cell rendered">
<div class="input">
<div class="prompt input_prompt">In&nbsp;[&nbsp;]:</div>
<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="c1"># define helper functions for visualizations</span>
<span class="k">def</span> <span class="nf">plot_examples</span><span class="p">(</span><span class="n">images</span><span class="p">,</span> <span class="n">cls_true</span><span class="p">,</span> <span class="n">cls_pred</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
    <span class="n">n_examples</span> <span class="o">=</span> <span class="n">images</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
    <span class="n">m</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">ceil</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">n_examples</span><span class="p">)))</span>
    <span class="n">fig</span><span class="p">,</span> <span class="n">axes</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="n">m</span><span class="p">,</span> <span class="n">m</span><span class="p">)</span>
    <span class="n">fig</span><span class="o">.</span><span class="n">set_size_inches</span><span class="p">((</span><span class="mi">12</span><span class="p">,</span> <span class="mi">11</span><span class="p">))</span>
    <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">ax</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">axes</span><span class="o">.</span><span class="n">flat</span><span class="p">):</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">images</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span> <span class="o">==</span> <span class="mi">4</span><span class="p">:</span>
            <span class="n">ax</span><span class="o">.</span><span class="n">imshow</span><span class="p">(</span><span class="n">images</span><span class="p">[</span><span class="n">i</span><span class="p">,</span> <span class="p">:,</span> <span class="p">:,</span> <span class="mi">0</span><span class="p">],</span> <span class="n">cmap</span><span class="o">=</span><span class="s1">&#39;gray&#39;</span><span class="p">)</span>
        <span class="k">elif</span> <span class="nb">len</span><span class="p">(</span><span class="n">images</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span> <span class="o">==</span> <span class="mi">3</span><span class="p">:</span>
            <span class="n">ax</span><span class="o">.</span><span class="n">imshow</span><span class="p">(</span><span class="n">images</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="n">cmap</span><span class="o">=</span><span class="s1">&#39;gray&#39;</span><span class="p">)</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">cls_true</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
            <span class="bp">cls</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">argmax</span><span class="p">(</span><span class="n">cls_true</span><span class="p">[</span><span class="n">i</span><span class="p">])</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">cls</span> <span class="o">=</span> <span class="n">cls_true</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
        <span class="k">if</span> <span class="n">cls_pred</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">xlabel</span> <span class="o">=</span> <span class="s2">&quot;Label: </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="bp">cls</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">cls_pred</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
                <span class="n">pred</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">argmax</span><span class="p">(</span><span class="n">cls_pred</span><span class="p">[</span><span class="n">i</span><span class="p">])</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">pred</span> <span class="o">=</span> <span class="n">cls_pred</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
            <span class="n">xlabel</span> <span class="o">=</span> <span class="s2">&quot;True: </span><span class="si">{}</span><span class="s2">, Pred: </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="n">pred</span><span class="p">)</span>
        
        <span class="c1"># Show the classes as the label on the x-axis.</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="n">xlabel</span><span class="p">)</span>
        
        <span class="c1"># Remove ticks from the plot.</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">set_xticks</span><span class="p">([])</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">set_yticks</span><span class="p">([])</span>

    <span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</pre></div>

</div>
</div>
</div>

</div>
<div class="cell border-box-sizing text_cell rendered"><div class="prompt input_prompt">
</div>
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<h4 id="Take-a-look-at-your-data">Take a look at your data<a class="anchor-link" href="#Take-a-look-at-your-data">&#182;</a></h4><p>Let's just take a look at some data using our plotting helper function:</p>

</div>
</div>
</div>
<div class="cell border-box-sizing code_cell rendered">
<div class="input">
<div class="prompt input_prompt">In&nbsp;[&nbsp;]:</div>
<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">plot_examples</span><span class="p">(</span><span class="n">X_train</span><span class="p">[</span><span class="mi">20</span><span class="p">:</span><span class="mi">29</span><span class="p">,</span> <span class="p">:,</span> <span class="p">:,</span> <span class="mi">0</span><span class="p">],</span> <span class="n">y_train</span><span class="p">[</span><span class="mi">20</span><span class="p">:</span><span class="mi">30</span><span class="p">])</span>
</pre></div>

</div>
</div>
</div>

</div>
<div class="cell border-box-sizing text_cell rendered"><div class="prompt input_prompt">
</div>
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<h4 id="%-Work-in-Progress-%-Random-Preprocessing">% Work in Progress % Random Preprocessing<a class="anchor-link" href="#%-Work-in-Progress-%-Random-Preprocessing">&#182;</a></h4><p>So this dataset is pretty vanilla.  We don't actually expect spatial transformations to do much, if anything, to digits which are already properly oriented.</p>
<p>When I have some extra time I will add some randomization to the mix to test the limitations of the spatial transformer a bit further.</p>

</div>
</div>
</div>
<div class="cell border-box-sizing text_cell rendered"><div class="prompt input_prompt">
</div>
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<h3 id="Defining-the-Model">Defining the Model<a class="anchor-link" href="#Defining-the-Model">&#182;</a></h3><p>We'll need to set up the pieces of the spatial transformer module, and then plug it into a standard CNN.</p>
<p>First, we'll define the <strong>localizer</strong>.
Remember that this is really the same as a small CNN. In a naive approach, I'm simply putting some parameters at the end, forced into a <strong>sigmoid activation</strong>, without concern for their meaning within a transformation matrix...</p>
<p>I'll also define a <strong>standard cnn</strong> for classification.
This will help later for comparing STN results to regular networks, as it will serve as both a stand alone CNN, and as the CNN we feed the output of the Spatial Transformer into.</p>

</div>
</div>
</div>
<div class="cell border-box-sizing code_cell rendered">
<div class="input">
<div class="prompt input_prompt">In&nbsp;[&nbsp;]:</div>
<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="k">def</span> <span class="nf">localizer</span><span class="p">(</span><span class="n">input_layer</span><span class="p">,</span> <span class="n">constraints</span><span class="p">):</span>
    <span class="k">if</span> <span class="n">constraints</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">num_params</span> <span class="o">=</span> <span class="n">constraints</span><span class="o">.</span><span class="n">num_free_params</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">num_params</span> <span class="o">=</span> <span class="mi">6</span>
    <span class="n">graph</span> <span class="o">=</span> <span class="n">keras</span><span class="o">.</span><span class="n">layers</span><span class="o">.</span><span class="n">Conv2D</span><span class="p">(</span><span class="n">filters</span><span class="o">=</span><span class="mi">64</span><span class="p">,</span> <span class="n">kernel_size</span><span class="o">=</span><span class="p">(</span><span class="mi">3</span><span class="p">,</span> <span class="mi">3</span><span class="p">),</span> <span class="n">activation</span><span class="o">=</span><span class="s1">&#39;relu&#39;</span><span class="p">)(</span><span class="n">input_layer</span><span class="p">)</span>
    <span class="n">graph</span> <span class="o">=</span> <span class="n">keras</span><span class="o">.</span><span class="n">layers</span><span class="o">.</span><span class="n">MaxPool2D</span><span class="p">(</span><span class="n">pool_size</span><span class="o">=</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="mi">2</span><span class="p">),</span> <span class="n">strides</span><span class="o">=</span><span class="mi">2</span><span class="p">)(</span><span class="n">graph</span><span class="p">)</span>
    <span class="n">graph</span> <span class="o">=</span> <span class="n">keras</span><span class="o">.</span><span class="n">layers</span><span class="o">.</span><span class="n">Conv2D</span><span class="p">(</span><span class="n">filters</span><span class="o">=</span><span class="mi">64</span><span class="p">,</span> <span class="n">kernel_size</span><span class="o">=</span><span class="p">(</span><span class="mi">3</span><span class="p">,</span> <span class="mi">3</span><span class="p">),</span> <span class="n">activation</span><span class="o">=</span><span class="s1">&#39;relu&#39;</span><span class="p">)(</span><span class="n">graph</span><span class="p">)</span>
    <span class="n">graph</span> <span class="o">=</span> <span class="n">keras</span><span class="o">.</span><span class="n">layers</span><span class="o">.</span><span class="n">MaxPool2D</span><span class="p">(</span><span class="n">pool_size</span><span class="o">=</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="mi">2</span><span class="p">),</span> <span class="n">strides</span><span class="o">=</span><span class="mi">2</span><span class="p">)(</span><span class="n">graph</span><span class="p">)</span>
    <span class="n">graph</span> <span class="o">=</span> <span class="n">keras</span><span class="o">.</span><span class="n">layers</span><span class="o">.</span><span class="n">Conv2D</span><span class="p">(</span><span class="n">filters</span><span class="o">=</span><span class="mi">64</span><span class="p">,</span> <span class="n">kernel_size</span><span class="o">=</span><span class="p">(</span><span class="mi">3</span><span class="p">,</span> <span class="mi">3</span><span class="p">),</span> <span class="n">activation</span><span class="o">=</span><span class="s1">&#39;relu&#39;</span><span class="p">)(</span><span class="n">graph</span><span class="p">)</span>
    <span class="n">graph</span> <span class="o">=</span> <span class="n">keras</span><span class="o">.</span><span class="n">layers</span><span class="o">.</span><span class="n">MaxPool2D</span><span class="p">(</span><span class="n">pool_size</span><span class="o">=</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="mi">2</span><span class="p">),</span> <span class="n">strides</span><span class="o">=</span><span class="mi">2</span><span class="p">)(</span><span class="n">graph</span><span class="p">)</span>
    <span class="n">graph</span> <span class="o">=</span> <span class="n">keras</span><span class="o">.</span><span class="n">layers</span><span class="o">.</span><span class="n">Flatten</span><span class="p">()(</span><span class="n">graph</span><span class="p">)</span>
    <span class="n">theta</span> <span class="o">=</span> <span class="n">keras</span><span class="o">.</span><span class="n">layers</span><span class="o">.</span><span class="n">Dense</span><span class="p">(</span><span class="n">units</span><span class="o">=</span><span class="n">num_params</span><span class="p">,</span> <span class="n">activation</span><span class="o">=</span><span class="s1">&#39;sigmoid&#39;</span><span class="p">)(</span><span class="n">graph</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">theta</span>


<span class="k">def</span> <span class="nf">cnn_model_fn</span><span class="p">(</span><span class="n">input_layer</span><span class="p">,</span> <span class="n">dense_units</span><span class="p">,</span> <span class="n">num_classes</span><span class="p">):</span>
    <span class="n">graph</span> <span class="o">=</span> <span class="n">input_layer</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">2</span><span class="p">):</span>
        <span class="n">graph</span> <span class="o">=</span> <span class="n">keras</span><span class="o">.</span><span class="n">layers</span><span class="o">.</span><span class="n">Conv2D</span><span class="p">(</span><span class="n">filters</span><span class="o">=</span><span class="mi">32</span> <span class="o">*</span> <span class="mi">2</span><span class="o">**</span><span class="n">i</span><span class="p">,</span> <span class="n">kernel_size</span><span class="o">=</span><span class="p">(</span><span class="mi">3</span><span class="p">,</span> <span class="mi">3</span><span class="p">),</span> <span class="n">activation</span><span class="o">=</span><span class="s1">&#39;relu&#39;</span><span class="p">)(</span><span class="n">graph</span><span class="p">)</span>
        <span class="n">graph</span> <span class="o">=</span> <span class="n">keras</span><span class="o">.</span><span class="n">layers</span><span class="o">.</span><span class="n">MaxPool2D</span><span class="p">(</span><span class="n">pool_size</span><span class="o">=</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="mi">2</span><span class="p">),</span> <span class="n">strides</span><span class="o">=</span><span class="mi">2</span><span class="p">)(</span><span class="n">graph</span><span class="p">)</span>
    <span class="n">graph</span> <span class="o">=</span> <span class="n">keras</span><span class="o">.</span><span class="n">layers</span><span class="o">.</span><span class="n">Flatten</span><span class="p">()(</span><span class="n">graph</span><span class="p">)</span>
    <span class="n">graph</span> <span class="o">=</span> <span class="n">keras</span><span class="o">.</span><span class="n">layers</span><span class="o">.</span><span class="n">Dense</span><span class="p">(</span>
        <span class="n">units</span><span class="o">=</span><span class="n">dense_units</span><span class="p">,</span> <span class="n">activation</span><span class="o">=</span><span class="s1">&#39;sigmoid&#39;</span><span class="p">)(</span><span class="n">graph</span><span class="p">)</span>
    <span class="n">dense</span> <span class="o">=</span> <span class="n">keras</span><span class="o">.</span><span class="n">layers</span><span class="o">.</span><span class="n">Dense</span><span class="p">(</span><span class="n">num_classes</span><span class="p">)(</span><span class="n">graph</span><span class="p">)</span>
    <span class="n">logits</span> <span class="o">=</span> <span class="n">keras</span><span class="o">.</span><span class="n">layers</span><span class="o">.</span><span class="n">Activation</span><span class="p">(</span><span class="s1">&#39;softmax&#39;</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="s1">&#39;y&#39;</span><span class="p">)(</span><span class="n">dense</span><span class="p">)</span>
    
    <span class="k">return</span> <span class="n">logits</span>

<span class="k">def</span> <span class="nf">standard_cnn</span><span class="p">(</span><span class="o">**</span><span class="n">pm</span><span class="p">):</span>
    <span class="n">X</span> <span class="o">=</span> <span class="n">keras</span><span class="o">.</span><span class="n">layers</span><span class="o">.</span><span class="n">Input</span><span class="p">(</span>
        <span class="n">shape</span><span class="o">=</span><span class="n">pm</span><span class="p">[</span><span class="s1">&#39;input_shape&#39;</span><span class="p">],</span> <span class="n">name</span><span class="o">=</span><span class="s1">&#39;X&#39;</span><span class="p">)</span>
    <span class="n">output</span> <span class="o">=</span> <span class="n">cnn_model_fn</span><span class="p">(</span><span class="n">X</span><span class="p">,</span> <span class="n">pm</span><span class="p">[</span><span class="s1">&#39;dense_units&#39;</span><span class="p">],</span> <span class="n">pm</span><span class="p">[</span><span class="s1">&#39;num_classes&#39;</span><span class="p">])</span>
    <span class="n">model</span> <span class="o">=</span> <span class="n">keras</span><span class="o">.</span><span class="n">Model</span><span class="p">(</span><span class="n">inputs</span><span class="o">=</span><span class="n">X</span><span class="p">,</span> <span class="n">outputs</span><span class="o">=</span><span class="n">output</span><span class="p">)</span>
    <span class="n">opt</span> <span class="o">=</span> <span class="n">keras</span><span class="o">.</span><span class="n">optimizers</span><span class="o">.</span><span class="n">Adam</span><span class="p">()</span>
    <span class="n">model</span><span class="o">.</span><span class="n">compile</span><span class="p">(</span><span class="n">loss</span><span class="o">=</span><span class="s1">&#39;categorical_crossentropy&#39;</span><span class="p">,</span>
                  <span class="n">optimizer</span><span class="o">=</span><span class="n">opt</span><span class="p">,</span> <span class="n">metrics</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;accuracy&#39;</span><span class="p">])</span>
    <span class="k">return</span> <span class="n">model</span>
</pre></div>

</div>
</div>
</div>

</div>
<div class="cell border-box-sizing text_cell rendered"><div class="prompt input_prompt">
</div>
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<p>Next, we'll define a special module, using Deepmind Sonnet's tensorflow package.
This module, which I'm calling the Spatial Transform Layer, is meant to take care of generating the grid points and the resampling.</p>
<p>I've defined it to accept a tuple of inputs: the input image, and the transform parameters (the output layer of the localization network). The tuple input works more seamlessly with keras.</p>

</div>
</div>
</div>
<div class="cell border-box-sizing code_cell rendered">
<div class="input">
<div class="prompt input_prompt">In&nbsp;[&nbsp;]:</div>
<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="k">class</span> <span class="nc">SpatialTransformLayer</span><span class="p">(</span><span class="n">snt</span><span class="o">.</span><span class="n">AbstractModule</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    affine transform layer.</span>
<span class="sd">    Constructor requires output_shape, with optional</span>
<span class="sd">    constraints and boundary.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">output_shape</span><span class="p">,</span>
                 <span class="n">constraints</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                 <span class="n">name</span><span class="o">=</span><span class="s1">&#39;stn_layer&#39;</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        :param output_shape: shape of output layer (not including batch size)</span>
<span class="sd">        :param constraints: AffineWarpConstraints object from dm-sonnet package</span>
<span class="sd">        :param name: layer name</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="n">name</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">constraints</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="c1"># default is full affine transform</span>
            <span class="n">constraints</span> <span class="o">=</span> <span class="n">snt</span><span class="o">.</span><span class="n">AffineWarpConstraints</span><span class="o">.</span><span class="n">no_constraints</span><span class="p">(</span><span class="n">num_dim</span><span class="o">=</span><span class="mi">2</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_constraints</span> <span class="o">=</span> <span class="n">constraints</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_output_shape</span> <span class="o">=</span> <span class="n">output_shape</span>
        <span class="bp">self</span><span class="o">.</span><span class="vm">__name__</span> <span class="o">=</span> <span class="n">name</span>

    <span class="k">def</span> <span class="nf">_build</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">inputs</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Layer requires a tuple of arguments: an input layer</span>
<span class="sd">        and a set of transform parameters.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">U</span><span class="p">,</span> <span class="n">theta</span> <span class="o">=</span> <span class="n">inputs</span>
        <span class="n">grid</span> <span class="o">=</span> <span class="n">snt</span><span class="o">.</span><span class="n">AffineGridWarper</span><span class="p">(</span>
            <span class="n">source_shape</span><span class="o">=</span><span class="n">U</span><span class="o">.</span><span class="n">get_shape</span><span class="p">()</span><span class="o">.</span><span class="n">as_list</span><span class="p">()[</span><span class="mi">1</span><span class="p">:</span><span class="o">-</span><span class="mi">1</span><span class="p">],</span>
            <span class="n">output_shape</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_output_shape</span><span class="p">,</span>
            <span class="n">constraints</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_constraints</span><span class="p">)(</span><span class="n">theta</span><span class="p">)</span>
        <span class="n">V</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">contrib</span><span class="o">.</span><span class="n">resampler</span><span class="o">.</span><span class="n">resampler</span><span class="p">(</span><span class="n">U</span><span class="p">,</span> <span class="n">grid</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="s1">&#39;resampler&#39;</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">V</span>
</pre></div>

</div>
</div>
</div>

</div>
<div class="cell border-box-sizing text_cell rendered"><div class="prompt input_prompt">
</div>
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<p>finally, we have the tools to finalize the model.
The format is basic, just to take inputs and transform them.</p>

</div>
</div>
</div>
<div class="cell border-box-sizing code_cell rendered">
<div class="input">
<div class="prompt input_prompt">In&nbsp;[&nbsp;]:</div>
<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="c1"># define our keras model</span>
<span class="k">def</span> <span class="nf">stn_model_fn</span><span class="p">(</span><span class="o">**</span><span class="n">pm</span><span class="p">):</span>

    <span class="c1"># input layer</span>
    <span class="n">U</span> <span class="o">=</span> <span class="n">keras</span><span class="o">.</span><span class="n">layers</span><span class="o">.</span><span class="n">Input</span><span class="p">(</span>
        <span class="n">shape</span><span class="o">=</span><span class="n">pm</span><span class="p">[</span><span class="s1">&#39;input_shape&#39;</span><span class="p">],</span> <span class="n">name</span><span class="o">=</span><span class="s1">&#39;X&#39;</span><span class="p">)</span>

    <span class="c1"># create localizationnetwork</span>
    <span class="n">theta</span> <span class="o">=</span> <span class="n">localizer</span><span class="p">(</span><span class="n">U</span><span class="p">,</span> <span class="n">pm</span><span class="p">[</span><span class="s1">&#39;constraints&#39;</span><span class="p">])</span>

    <span class="n">grid_resampler</span> <span class="o">=</span> <span class="n">SpatialTransformLayer</span><span class="p">(</span><span class="n">output_shape</span><span class="o">=</span><span class="n">pm</span><span class="p">[</span><span class="s1">&#39;output_shape&#39;</span><span class="p">],</span>
                                           <span class="n">constraints</span><span class="o">=</span><span class="n">pm</span><span class="p">[</span><span class="s1">&#39;constraints&#39;</span><span class="p">])</span>

    <span class="c1"># feed input U and parameters theta into the grid resampler</span>
    <span class="n">V</span> <span class="o">=</span> <span class="n">keras</span><span class="o">.</span><span class="n">layers</span><span class="o">.</span><span class="n">Lambda</span><span class="p">(</span>
        <span class="n">grid_resampler</span><span class="p">,</span> <span class="n">output_shape</span><span class="o">=</span><span class="n">pm</span><span class="p">[</span><span class="s1">&#39;output_shape&#39;</span><span class="p">],</span> <span class="n">name</span><span class="o">=</span><span class="s1">&#39;V&#39;</span><span class="p">)([</span><span class="n">U</span><span class="p">,</span> <span class="n">theta</span><span class="p">])</span>

    <span class="c1"># now input V to a standard cnn</span>
    <span class="n">logits</span> <span class="o">=</span> <span class="n">cnn_model_fn</span><span class="p">(</span><span class="n">V</span><span class="p">,</span> <span class="n">pm</span><span class="p">[</span><span class="s1">&#39;dense_units&#39;</span><span class="p">],</span> <span class="n">pm</span><span class="p">[</span><span class="s1">&#39;num_classes&#39;</span><span class="p">])</span>
    
    <span class="n">model</span> <span class="o">=</span> <span class="n">keras</span><span class="o">.</span><span class="n">Model</span><span class="p">(</span><span class="n">inputs</span><span class="o">=</span><span class="n">U</span><span class="p">,</span> <span class="n">outputs</span><span class="o">=</span><span class="n">logits</span><span class="p">)</span>
    <span class="n">opt</span> <span class="o">=</span> <span class="n">keras</span><span class="o">.</span><span class="n">optimizers</span><span class="o">.</span><span class="n">Adam</span><span class="p">()</span>
    <span class="n">model</span><span class="o">.</span><span class="n">compile</span><span class="p">(</span><span class="n">loss</span><span class="o">=</span><span class="s1">&#39;categorical_crossentropy&#39;</span><span class="p">,</span>
                  <span class="n">optimizer</span><span class="o">=</span><span class="n">opt</span><span class="p">,</span> <span class="n">metrics</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;accuracy&#39;</span><span class="p">])</span>

    <span class="k">return</span> <span class="n">model</span>


<span class="c1"># create some boundaries on the affine warp</span>
<span class="n">constraints</span> <span class="o">=</span> <span class="n">snt</span><span class="o">.</span><span class="n">AffineWarpConstraints</span><span class="p">([[</span><span class="kc">None</span><span class="p">,</span> <span class="kc">None</span><span class="p">,</span> <span class="kc">None</span><span class="p">],</span>
                                         <span class="p">[</span><span class="kc">None</span><span class="p">,</span> <span class="kc">None</span><span class="p">,</span> <span class="kc">None</span><span class="p">]])</span>

<span class="n">model_parameters</span> <span class="o">=</span> <span class="p">{</span>
    <span class="s1">&#39;input_shape&#39;</span><span class="p">:</span> <span class="p">(</span><span class="mi">28</span><span class="p">,</span> <span class="mi">28</span><span class="p">,</span> <span class="mi">1</span><span class="p">),</span>
    <span class="s1">&#39;batch_size&#39;</span><span class="p">:</span> <span class="mi">32</span><span class="p">,</span>
    <span class="s1">&#39;output_shape&#39;</span><span class="p">:</span> <span class="p">(</span><span class="mi">28</span><span class="p">,</span> <span class="mi">28</span><span class="p">),</span>
    <span class="s1">&#39;constraints&#39;</span><span class="p">:</span> <span class="n">constraints</span><span class="p">,</span>
    <span class="s1">&#39;dense_units&#39;</span><span class="p">:</span> <span class="mi">128</span><span class="p">,</span>
    <span class="s1">&#39;num_classes&#39;</span><span class="p">:</span> <span class="mi">10</span>
<span class="p">}</span>
</pre></div>

</div>
</div>
</div>

</div>
<div class="cell border-box-sizing text_cell rendered"><div class="prompt input_prompt">
</div>
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<h2 id="Testing-the-Models">Testing the Models<a class="anchor-link" href="#Testing-the-Models">&#182;</a></h2><p>Now that we've written up the models themselves, let's initialize each a <strong>Standard CNN</strong> and a <strong>Spatial Transformer Module hooked up to a Standard CNN</strong></p>
<p>Since the CNNs have the same basic architecture, we expect to see how STNs may change what goes in, and hopefully, get a glimpse of how they change kernels of the model later.</p>

</div>
</div>
</div>
<div class="cell border-box-sizing code_cell rendered">
<div class="input">
<div class="prompt input_prompt">In&nbsp;[&nbsp;]:</div>
<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">K</span><span class="o">.</span><span class="n">clear_session</span><span class="p">()</span>
<span class="n">tf</span><span class="o">.</span><span class="n">set_random_seed</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
</pre></div>

</div>
</div>
</div>

</div>
<div class="cell border-box-sizing code_cell rendered">
<div class="input">
<div class="prompt input_prompt">In&nbsp;[&nbsp;]:</div>
<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">normal_model</span> <span class="o">=</span> <span class="n">standard_cnn</span><span class="p">(</span><span class="o">**</span><span class="n">model_parameters</span><span class="p">)</span>
<span class="n">normal_model</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span><span class="n">x</span><span class="o">=</span><span class="n">X_train</span><span class="p">,</span> <span class="n">y</span><span class="o">=</span><span class="n">y_train</span><span class="p">,</span> <span class="n">validation_data</span><span class="o">=</span><span class="p">(</span><span class="n">X_test</span><span class="p">,</span> <span class="n">y_test</span><span class="p">),</span> <span class="n">epochs</span><span class="o">=</span><span class="mi">10</span><span class="p">,</span> <span class="n">batch_size</span><span class="o">=</span><span class="mi">32</span><span class="p">)</span>
</pre></div>

</div>
</div>
</div>

</div>
<div class="cell border-box-sizing code_cell rendered">
<div class="input">
<div class="prompt input_prompt">In&nbsp;[&nbsp;]:</div>
<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">model</span> <span class="o">=</span> <span class="n">stn_model_fn</span><span class="p">(</span><span class="o">**</span><span class="n">model_parameters</span><span class="p">)</span>
<span class="n">model</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span><span class="n">x</span><span class="o">=</span><span class="n">X_train</span><span class="p">,</span> <span class="n">y</span><span class="o">=</span><span class="n">y_train</span><span class="p">,</span> <span class="n">validation_data</span><span class="o">=</span><span class="p">(</span><span class="n">X_test</span><span class="p">,</span> <span class="n">y_test</span><span class="p">),</span> <span class="n">epochs</span><span class="o">=</span><span class="mi">10</span><span class="p">,</span> <span class="n">batch_size</span><span class="o">=</span><span class="mi">32</span><span class="p">)</span>
</pre></div>

</div>
</div>
</div>

</div>
<div class="cell border-box-sizing text_cell rendered"><div class="prompt input_prompt">
</div>
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<h3 id="What-is-the-STN-getting-wrong?">What is the STN getting wrong?<a class="anchor-link" href="#What-is-the-STN-getting-wrong?">&#182;</a></h3><p>We end up with 95% accuracy in the STN and 98% accuracy in the standard CNN.  So what gives?</p>
<p>I should take this time to note, the accuracy of the STN was quite random, indicating a serious problem with initialization, quite frequently it was near chance, 10%.  <em>Can you guess why?</em></p>
<p>let's look at some examples where the STN is having trouble classifying, to see what might be going on.</p>

</div>
</div>
</div>
<div class="cell border-box-sizing code_cell rendered">
<div class="input">
<div class="prompt input_prompt">In&nbsp;[&nbsp;]:</div>
<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">resampler</span> <span class="o">=</span> <span class="n">keras</span><span class="o">.</span><span class="n">Model</span><span class="p">(</span><span class="n">inputs</span><span class="o">=</span><span class="n">model</span><span class="o">.</span><span class="n">input</span><span class="p">,</span>
                        <span class="n">outputs</span><span class="o">=</span><span class="n">model</span><span class="o">.</span><span class="n">get_layer</span><span class="p">(</span><span class="s1">&#39;V&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">output</span><span class="p">)</span>
</pre></div>

</div>
</div>
</div>

</div>
<div class="cell border-box-sizing code_cell rendered">
<div class="input">
<div class="prompt input_prompt">In&nbsp;[&nbsp;]:</div>
<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="c1"># some samples</span>
<span class="n">y_pred</span> <span class="o">=</span> <span class="n">model</span><span class="o">.</span><span class="n">predict</span><span class="p">(</span><span class="n">X_test</span><span class="p">)</span>
<span class="n">cls_pred</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">argmax</span><span class="p">(</span><span class="n">y_pred</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
<span class="n">cls_true</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">argmax</span><span class="p">(</span><span class="n">y_test</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
</pre></div>

</div>
</div>
</div>

</div>
<div class="cell border-box-sizing code_cell rendered">
<div class="input">
<div class="prompt input_prompt">In&nbsp;[&nbsp;]:</div>
<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">bad_preds</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">argwhere</span><span class="p">(</span><span class="n">cls_pred</span> <span class="o">!=</span> <span class="n">cls_true</span><span class="p">)</span><span class="o">.</span><span class="n">flatten</span><span class="p">()</span>
</pre></div>

</div>
</div>
</div>

</div>
<div class="cell border-box-sizing code_cell rendered">
<div class="input">
<div class="prompt input_prompt">In&nbsp;[&nbsp;]:</div>
<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">examples</span> <span class="o">=</span> <span class="n">bad_preds</span><span class="p">[:</span><span class="mi">9</span><span class="p">]</span>
<span class="n">U_images</span> <span class="o">=</span> <span class="n">X_test</span><span class="p">[</span><span class="n">examples</span><span class="p">]</span>
<span class="n">V_images</span> <span class="o">=</span> <span class="n">resampler</span><span class="o">.</span><span class="n">predict</span><span class="p">(</span><span class="n">U_images</span><span class="p">)</span>
</pre></div>

</div>
</div>
</div>

</div>
<div class="cell border-box-sizing code_cell rendered">
<div class="input">
<div class="prompt input_prompt">In&nbsp;[&nbsp;]:</div>
<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">plot_examples</span><span class="p">(</span><span class="n">U_images</span><span class="p">,</span> <span class="n">cls_true</span><span class="p">[</span><span class="n">examples</span><span class="p">],</span> <span class="n">cls_pred</span><span class="p">[</span><span class="n">examples</span><span class="p">])</span>
</pre></div>

</div>
</div>
</div>

</div>
<div class="cell border-box-sizing code_cell rendered">
<div class="input">
<div class="prompt input_prompt">In&nbsp;[&nbsp;]:</div>
<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">plot_examples</span><span class="p">(</span><span class="n">V_images</span><span class="p">,</span> <span class="n">cls_true</span><span class="p">[</span><span class="n">examples</span><span class="p">],</span> <span class="n">cls_pred</span><span class="p">[</span><span class="n">examples</span><span class="p">])</span>
</pre></div>

</div>
</div>
</div>

</div>
<div class="cell border-box-sizing text_cell rendered"><div class="prompt input_prompt">
</div>
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<h2 id="The-Localizer-Network-is-more-nuanced-than-the-paper-admits">The Localizer Network is more nuanced than the paper admits<a class="anchor-link" href="#The-Localizer-Network-is-more-nuanced-than-the-paper-admits">&#182;</a></h2><p>The authors don't make any statements about just how sensitive these layers are. Think about it:  Out of all the possible transformations, there are <em>a lot of them</em> that actually land outside of the original image entirely, or grab a useless zero region in the MNIST case. To fix this, we redefine the localizer network.</p>
<p>Let's give it strict activation functions such as sigmoid and tanh, then add an identity matrix to the final theta layer.
The idea here is that the parameters theta should start very small, and slowly learn how to change from an identity transformation (retaining the image $U$ as-is) to finding a convenient transform to $V$ to assist the standard CNN.</p>

</div>
</div>
</div>
<div class="cell border-box-sizing code_cell rendered">
<div class="input">
<div class="prompt input_prompt">In&nbsp;[&nbsp;]:</div>
<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="k">def</span> <span class="nf">localizer</span><span class="p">(</span><span class="n">input_layer</span><span class="p">,</span> <span class="n">constraints</span><span class="p">):</span>
    <span class="k">if</span> <span class="n">constraints</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">num_params</span> <span class="o">=</span> <span class="n">constraints</span><span class="o">.</span><span class="n">num_free_params</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">num_params</span> <span class="o">=</span> <span class="mi">6</span>
    <span class="n">graph</span> <span class="o">=</span> <span class="n">keras</span><span class="o">.</span><span class="n">layers</span><span class="o">.</span><span class="n">Conv2D</span><span class="p">(</span><span class="n">filters</span><span class="o">=</span><span class="mi">64</span><span class="p">,</span> <span class="n">kernel_size</span><span class="o">=</span><span class="p">(</span><span class="mi">3</span><span class="p">,</span> <span class="mi">3</span><span class="p">),</span> <span class="n">activation</span><span class="o">=</span><span class="s1">&#39;sigmoid&#39;</span><span class="p">)(</span><span class="n">input_layer</span><span class="p">)</span>
    <span class="n">graph</span> <span class="o">=</span> <span class="n">keras</span><span class="o">.</span><span class="n">layers</span><span class="o">.</span><span class="n">MaxPool2D</span><span class="p">(</span><span class="n">pool_size</span><span class="o">=</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="mi">2</span><span class="p">),</span> <span class="n">strides</span><span class="o">=</span><span class="mi">2</span><span class="p">)(</span><span class="n">graph</span><span class="p">)</span>
    <span class="n">graph</span> <span class="o">=</span> <span class="n">keras</span><span class="o">.</span><span class="n">layers</span><span class="o">.</span><span class="n">Conv2D</span><span class="p">(</span><span class="n">filters</span><span class="o">=</span><span class="mi">64</span><span class="p">,</span> <span class="n">kernel_size</span><span class="o">=</span><span class="p">(</span><span class="mi">3</span><span class="p">,</span> <span class="mi">3</span><span class="p">),</span> <span class="n">activation</span><span class="o">=</span><span class="s1">&#39;sigmoid&#39;</span><span class="p">)(</span><span class="n">graph</span><span class="p">)</span>
    <span class="n">graph</span> <span class="o">=</span> <span class="n">keras</span><span class="o">.</span><span class="n">layers</span><span class="o">.</span><span class="n">MaxPool2D</span><span class="p">(</span><span class="n">pool_size</span><span class="o">=</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="mi">2</span><span class="p">),</span> <span class="n">strides</span><span class="o">=</span><span class="mi">2</span><span class="p">)(</span><span class="n">graph</span><span class="p">)</span>
    <span class="n">graph</span> <span class="o">=</span> <span class="n">keras</span><span class="o">.</span><span class="n">layers</span><span class="o">.</span><span class="n">Conv2D</span><span class="p">(</span><span class="n">filters</span><span class="o">=</span><span class="mi">64</span><span class="p">,</span> <span class="n">kernel_size</span><span class="o">=</span><span class="p">(</span><span class="mi">3</span><span class="p">,</span> <span class="mi">3</span><span class="p">),</span> <span class="n">activation</span><span class="o">=</span><span class="s1">&#39;sigmoid&#39;</span><span class="p">)(</span><span class="n">graph</span><span class="p">)</span>
    <span class="n">graph</span> <span class="o">=</span> <span class="n">keras</span><span class="o">.</span><span class="n">layers</span><span class="o">.</span><span class="n">MaxPool2D</span><span class="p">(</span><span class="n">pool_size</span><span class="o">=</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="mi">2</span><span class="p">),</span> <span class="n">strides</span><span class="o">=</span><span class="mi">2</span><span class="p">)(</span><span class="n">graph</span><span class="p">)</span>
    <span class="n">graph</span> <span class="o">=</span> <span class="n">keras</span><span class="o">.</span><span class="n">layers</span><span class="o">.</span><span class="n">Flatten</span><span class="p">()(</span><span class="n">graph</span><span class="p">)</span>
    <span class="n">graph</span> <span class="o">=</span> <span class="n">keras</span><span class="o">.</span><span class="n">layers</span><span class="o">.</span><span class="n">Dense</span><span class="p">(</span><span class="n">units</span><span class="o">=</span><span class="n">num_params</span><span class="p">,</span> <span class="n">activation</span><span class="o">=</span><span class="s1">&#39;tanh&#39;</span><span class="p">,</span> <span class="n">bias_initializer</span><span class="o">=</span><span class="s1">&#39;zeros&#39;</span><span class="p">,</span> <span class="n">activity_regularizer</span><span class="o">=</span><span class="s1">&#39;l1&#39;</span><span class="p">)(</span><span class="n">graph</span><span class="p">)</span>
    <span class="c1"># hard code the affine transformation!</span>
    <span class="n">theta</span> <span class="o">=</span> <span class="n">keras</span><span class="o">.</span><span class="n">layers</span><span class="o">.</span><span class="n">Dense</span><span class="p">(</span><span class="n">units</span><span class="o">=</span><span class="n">num_params</span><span class="p">,</span> <span class="n">bias_initializer</span><span class="o">=</span><span class="s1">&#39;zeros&#39;</span><span class="p">,</span> <span class="n">activity_regularizer</span><span class="o">=</span><span class="s1">&#39;l1&#39;</span><span class="p">)(</span><span class="n">graph</span><span class="p">)</span>
    <span class="k">def</span> <span class="nf">add</span><span class="p">(</span><span class="n">theta</span><span class="p">):</span>        
        <span class="n">identity</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">constant</span><span class="p">([[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">]],</span> <span class="n">dtype</span><span class="o">=</span><span class="n">tf</span><span class="o">.</span><span class="n">float32</span><span class="p">)</span>
        <span class="n">theta</span> <span class="o">=</span> <span class="n">theta</span> <span class="o">+</span> <span class="n">identity</span>
        <span class="k">return</span> <span class="n">theta</span>
    
    <span class="n">theta</span> <span class="o">=</span> <span class="n">keras</span><span class="o">.</span><span class="n">layers</span><span class="o">.</span><span class="n">Lambda</span><span class="p">(</span><span class="n">add</span><span class="p">)(</span><span class="n">theta</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="n">theta</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">theta</span>
</pre></div>

</div>
</div>
</div>

</div>
<div class="cell border-box-sizing code_cell rendered">
<div class="input">
<div class="prompt input_prompt">In&nbsp;[&nbsp;]:</div>
<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">model</span> <span class="o">=</span> <span class="n">stn_model_fn</span><span class="p">(</span><span class="o">**</span><span class="n">model_parameters</span><span class="p">)</span>
<span class="n">model</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span><span class="n">x</span><span class="o">=</span><span class="n">X_train</span><span class="p">,</span> <span class="n">y</span><span class="o">=</span><span class="n">y_train</span><span class="p">,</span> <span class="n">validation_data</span><span class="o">=</span><span class="p">(</span><span class="n">X_test</span><span class="p">,</span> <span class="n">y_test</span><span class="p">),</span> <span class="n">epochs</span><span class="o">=</span><span class="mi">10</span><span class="p">,</span> <span class="n">batch_size</span><span class="o">=</span><span class="mi">32</span><span class="p">)</span>
</pre></div>

</div>
</div>
</div>

</div>
<div class="cell border-box-sizing text_cell rendered"><div class="prompt input_prompt">
</div>
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<p>Great! The performance is now much better, but let's see what this new model is having trouble with...</p>

</div>
</div>
</div>
<div class="cell border-box-sizing code_cell rendered">
<div class="input">
<div class="prompt input_prompt">In&nbsp;[&nbsp;]:</div>
<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="c1"># some samples</span>
<span class="n">y_pred</span> <span class="o">=</span> <span class="n">model</span><span class="o">.</span><span class="n">predict</span><span class="p">(</span><span class="n">X_test</span><span class="p">)</span>
<span class="n">cls_pred</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">argmax</span><span class="p">(</span><span class="n">y_pred</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
<span class="n">cls_true</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">argmax</span><span class="p">(</span><span class="n">y_test</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
</pre></div>

</div>
</div>
</div>

</div>
<div class="cell border-box-sizing code_cell rendered">
<div class="input">
<div class="prompt input_prompt">In&nbsp;[&nbsp;]:</div>
<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">bad_preds</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">argwhere</span><span class="p">(</span><span class="n">cls_pred</span> <span class="o">!=</span> <span class="n">cls_true</span><span class="p">)</span><span class="o">.</span><span class="n">flatten</span><span class="p">()</span>
<span class="n">examples</span> <span class="o">=</span> <span class="n">bad_preds</span><span class="p">[:</span><span class="mi">9</span><span class="p">]</span>
<span class="n">U_images</span> <span class="o">=</span> <span class="n">X_test</span><span class="p">[</span><span class="n">examples</span><span class="p">]</span>
<span class="n">V_images</span> <span class="o">=</span> <span class="n">resampler</span><span class="o">.</span><span class="n">predict</span><span class="p">(</span><span class="n">U_images</span><span class="p">)</span>
</pre></div>

</div>
</div>
</div>

</div>
<div class="cell border-box-sizing code_cell rendered">
<div class="input">
<div class="prompt input_prompt">In&nbsp;[&nbsp;]:</div>
<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">plot_examples</span><span class="p">(</span><span class="n">U_images</span><span class="p">,</span> <span class="n">cls_true</span><span class="p">[</span><span class="n">examples</span><span class="p">],</span> <span class="n">cls_pred</span><span class="p">[</span><span class="n">examples</span><span class="p">])</span>
</pre></div>

</div>
</div>
</div>

</div>
<div class="cell border-box-sizing code_cell rendered">
<div class="input">
<div class="prompt input_prompt">In&nbsp;[&nbsp;]:</div>
<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">plot_examples</span><span class="p">(</span><span class="n">V_images</span><span class="p">,</span> <span class="n">cls_true</span><span class="p">[</span><span class="n">examples</span><span class="p">],</span> <span class="n">cls_pred</span><span class="p">[</span><span class="n">examples</span><span class="p">])</span>
</pre></div>

</div>
</div>
</div>

</div>
<div class="cell border-box-sizing code_cell rendered">
<div class="input">
<div class="prompt input_prompt">In&nbsp;[&nbsp;]:</div>
<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">U_images</span> <span class="o">=</span> <span class="n">X_test</span><span class="p">[:</span><span class="mi">9</span><span class="p">]</span>
<span class="n">V_images</span> <span class="o">=</span> <span class="n">resampler</span><span class="o">.</span><span class="n">predict</span><span class="p">(</span><span class="n">U_images</span><span class="p">)</span>
</pre></div>

</div>
</div>
</div>

</div>
<div class="cell border-box-sizing code_cell rendered">
<div class="input">
<div class="prompt input_prompt">In&nbsp;[&nbsp;]:</div>
<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">cls_pred</span><span class="p">[</span><span class="n">examples</span><span class="p">]</span><span class="o">.</span><span class="n">shape</span>
</pre></div>

</div>
</div>
</div>

</div>
 


<script type="text/javascript">if (!document.getElementById('mathjaxscript_pelican_#%@#$@#')) {
    var mathjaxscript = document.createElement('script');
    mathjaxscript.id = 'mathjaxscript_pelican_#%@#$@#';
    mathjaxscript.type = 'text/javascript';
    mathjaxscript.src = '//cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.1/MathJax.js?config=TeX-AMS-MML_HTMLorMML';
    mathjaxscript[(window.opera ? "innerHTML" : "text")] =
        "MathJax.Hub.Config({" +
        "    config: ['MMLorHTML.js']," +
        "    TeX: { extensions: ['AMSmath.js','AMSsymbols.js','noErrors.js','noUndefined.js'], equationNumbers: { autoNumber: 'AMS' } }," +
        "    jax: ['input/TeX','input/MathML','output/HTML-CSS']," +
        "    extensions: ['tex2jax.js','mml2jax.js','MathMenu.js','MathZoom.js']," +
        "    displayAlign: 'center'," +
        "    displayIndent: '0em'," +
        "    showMathMenu: true," +
        "    tex2jax: { " +
        "        inlineMath: [ ['$','$'] ], " +
        "        displayMath: [ ['$$','$$'] ]," +
        "        processEscapes: true," +
        "        preview: 'TeX'," +
        "    }, " +
        "    'HTML-CSS': { " +
        " linebreaks: { automatic: true, width: '95% container' }, " +
        "        styles: { '.MathJax_Display, .MathJax .mo, .MathJax .mi, .MathJax .mn': {color: 'black ! important'} }" +
        "    } " +
        "}); ";
    (document.body || document.getElementsByTagName('head')[0]).appendChild(mathjaxscript);
}
</script>

  </div>
  <div class="tag-cloud">
    <p>
      <a href="https://dasturge.github.io/tag/computer-vision.html">computer vision</a>
      <a href="https://dasturge.github.io/tag/transforms.html">transforms</a>
      <a href="https://dasturge.github.io/tag/python.html">python</a>
      <a href="https://dasturge.github.io/tag/tensorflow.html">tensorflow</a>
    </p>
  </div>





</article>

    <footer>
<p>&copy;  </p>
<p>    Powered by <a href="http://getpelican.com" target="_blank">Pelican</a> - <a href="https://github.com/alexandrevicenzi/flex" target="_blank">Flex</a> theme by <a href="http://alexandrevicenzi.com" target="_blank">Alexandre Vicenzi</a>
</p>    </footer>
  </main>




<script type="application/ld+json">
{
  "@context" : "http://schema.org",
  "@type" : "Blog",
  "name": " S Vision ",
  "url" : "https://dasturge.github.io",
  "image": "/images/profile.jpg",
  "description": ""
}
</script>

</body>
</html>